<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" sizes="32x32" href="/logoTab.png">
  <title><%= product.productName %> - Casen</title>
  <!-- âœ… FIXED: NO TRAILING SPACES -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.10/dist/cdn.min.js"></script>
  <style>
    .color-fallback-black { background-color: #000; }
    .color-fallback-white { background-color: #fff; border: 1px solid #ccc; }
    .color-fallback-wine-red { background-color: #722F37; }
    .color-fallback-red { background-color: #ef4444; }
    .color-fallback-blue { background-color: #3b82f6; }
    .color-fallback-green { background-color: #10b981; }
    .color-fallback-pink { background-color: #ec4899; }
    .color-fallback-orange { background-color: #f97316; }
    .color-fallback-purple { background-color: #a855f7; }
    .color-fallback-gray { background-color: #9ca3af; }
    .color-fallback-violet { background-color: #8a2be2; }

    #zoomContainer {
      cursor: zoom-in;
      touch-action: none;
      position: relative;
      overflow: hidden;
    }
    #zoomLens {
      border: 1px solid rgba(255, 255, 255, 0.5);
      background-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      position: absolute;
      pointer-events: none;
    }
  </style>
</head>
<body class="bg-white text-gray-800 font-sans"
      x-data="productApp({
        productId: '<%= product._id %>',
        productName: '<%= product.productName %>',
        categoryName: '<%= product.category?.categoryName || '' %>',
        description: `<%= product.description || 'No description available.' %>`,
        isLoggedIn: <%= locals.user ? 'true' : 'false' %>,  <!-- âœ… Critical -->
        variants: <%= JSON.stringify(product.variants.map(v => ({
          _id: v._id.toString(),
          color: (v.color || 'Unknown').trim(),
          price: typeof v.price === 'number' ? v.price : (parseFloat(v.price) || 0),
          stock: typeof v.stock === 'number' ? v.stock : (parseInt(v.stock, 10) || 0),
          images: Array.isArray(v.images) ? v.images : ['https://placehold.co/600x600?text=No+Image']
        }))) %>
      })"
      x-init="init()">

  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center">
        <a href="/">
          <img src="/logo.png" alt="Logo" class="h-8 object-contain">
        </a>
      </div>
      <nav class="hidden md:flex space-x-5">
        <a href="/" class="text-sm font-medium transition-opacity hover:opacity-80">Home</a>
        <a href="#" class="text-sm font-medium transition-opacity hover:opacity-80">About</a>
        <a href="/products" class="text-sm font-medium transition-opacity hover:opacity-80">Phone Cases</a>
        <a href="#" class="text-sm font-medium transition-opacity hover:opacity-80">Tablet Cases</a>
        <a href="#" class="text-sm font-medium transition-opacity hover:opacity-80">Sale</a>
      </nav>
      <div class="flex items-center space-x-4">
        <button class="p-2 rounded-full hover:bg-gray-100 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
          </svg>
        </button>
        <button class="p-2 rounded-full hover:bg-gray-100 transition-colors relative" onclick="window.location.href='/cart'">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
        </button>

        <!-- User Menu -->
        <% if (locals.user && user.profilePic) { %>
        <div class="relative" x-data="{ open: false }" @click.away="open = false">
          <button @click="open = !open" class="rounded-full overflow-hidden w-8 h-8 border border-transparent hover:border-gray-300 transition-colors focus:outline-none">
            <img src="<%= user.profilePic %>" alt="Profile" class="w-full h-full object-cover" />
          </button>
          <div x-show="open" x-transition class="absolute right-0 mt-2 w-44 bg-white shadow-lg rounded-lg py-1 z-50">
            <a href="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Profile</a>
            <form action="/logout" method="post">
              <button type="submit" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Logout</button>
            </form>
          </div>
        </div>
        <% } else if (locals.user) { %>
        <div class="relative" x-data="{ open: false }" @click.away="open = false">
          <button @click="open = !open" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:text-gray-900">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
          </button>
          <div x-show="open" x-transition class="absolute right-0 mt-2 w-44 bg-white shadow-lg rounded-lg py-1 z-50">
            <a href="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Profile</a>
            <form action="/logout" method="post">
              <button type="submit" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Logout</button>
            </form>
          </div>
        </div>
        <% } else { %>
        <a href="/login" class="text-sm font-medium flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          Sign In
        </a>
        <% } %>

        <button class="md:hidden text-gray-600 hover:text-gray-900">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>
  </header>

  <nav aria-label="breadcrumb" class="container mx-auto px-4 mt-4">
    <ol class="flex items-center space-x-2 text-sm text-gray-500">
      <li><a href="/" class="hover:text-gray-700">Home</a></li>
      <li><span class="mx-1">/</span></li>
      <li><a href="/products" class="hover:text-gray-700">Products</a></li>
      <li><span class="mx-1">/</span></li>
      <li class="text-gray-900"><%= product.productName %></li>
    </ol>
  </nav>

  <main class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Image Gallery -->
      <div class="space-y-3">
        <div class="relative w-full aspect-square bg-gray-100 rounded-lg overflow-hidden group" id="zoomContainer">
          <img id="mainImage"
            :src="selectedVariant.images[0] || 'https://placehold.co/600x600?text=No+Image'"
            :alt="productName"
            class="w-full h-full object-contain transition-transform duration-200 ease-out"
          />
          <div id="zoomLens" class="hidden w-32 h-32 rounded-full absolute top-0 left-0"></div>
        </div>

        <div id="thumbnailGallery" class="flex space-x-2 overflow-x-auto pb-1">
          <template x-for="img in selectedVariant.images.slice(0, 5)" :key="img">
            <img 
              :src="img"
              class="w-16 h-16 object-cover border border-gray-300 rounded cursor-pointer flex-shrink-0 hover:border-blue-500 transition"
              @click="updateMainImage(img)"
            />
          </template>
        </div>

        
      </div>

      <!-- Product Details -->
      <div class="space-y-6">
        <div>
          <p class="text-sm text-gray-500" x-text="categoryName"></p>
          <p class="text-sm text-gray-500" x-text="productName"></p>
          <h1 class="text-2xl font-bold mt-1" x-text="selectedVariant.color || 'Color N/A'"></h1>
        </div>

        <div class="flex items-center space-x-2 text-sm text-orange-500">
          <i class="fas fa-fire"></i>
          <span>153+ bought in past month</span>
        </div>

        <div class="flex items-center space-x-4">
          <span class="text-xl font-bold text-red-500" x-text="`Rs. ${selectedVariant.price.toFixed(2)}`"></span>
        </div>

        <!-- Stock Status -->
        <div class="inline-flex items-center px-3 py-1 rounded-full text-sm"
             :class="selectedVariant.stock > 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
          <div x-show="selectedVariant.stock > 0" class="flex items-center">
            <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
            In stock (<span x-text="selectedVariant.stock"></span> available)
          </div>
          <div x-show="selectedVariant.stock <= 0" class="flex items-center">
            <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
            Out of stock
          </div>
        </div>

        <div class="bg-gray-50 p-4 rounded-lg">
          <h3 class="font-semibold mb-3">Color - <span x-text="selectedVariant.color || 'N/A'"></span></h3>
          <div class="flex space-x-3">
            <template x-for="(variant, index) in variants" :key="index">
              <div 
                class="w-10 h-10 rounded-full cursor-pointer border-2"
                :class="{
                  'border-blue-500': selectedVariantIndex === index,
                  'border-transparent': selectedVariantIndex !== index,
                  [getColorClass(variant.color)]: true
                }"
                @click="selectVariant(index)"
                :title="variant.color"
              ></div>
            </template>
          </div>
        </div>

        <!-- Description Accordion -->
        <div class="border-t border-gray-200 pt-4" @click="toggleAccordion('description')">
          <div class="flex justify-between items-center cursor-pointer">
            <h3 class="font-semibold">Description</h3>
            <i class="fas" :class="openSections.description ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
          </div>
          <div x-show="openSections.description" class="mt-3 text-sm text-gray-600">
            <p x-text="description"></p>
          </div>
        </div>

        <!-- Tech Spec Accordion -->
        <div class="border-t border-gray-200 pt-4" @click="toggleAccordion('spec')">
          <div class="flex justify-between items-center cursor-pointer">
            <h3 class="font-semibold">Technical Specification</h3>
            <i class="fas" :class="openSections.spec ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
          </div>
          <div x-show="openSections.spec" class="mt-3 text-sm text-gray-600">
            <div class="mb-3">
              <h4 class="font-medium mb-1">Material:</h4>
              <p x-text="categoryName || 'N/A'"></p>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex flex-col space-y-3">
          <div class="flex items-center space-x-4">
            <div class="flex items-center">
              <button 
                class="w-10 h-10 rounded-full bg-gray-100 text-gray-700 flex items-center justify-center 
                   hover:bg-gray-200 hover:shadow-sm transition-all duration-200 active:scale-95"
                @click="updateQuantity(-1)"
                :disabled="quantity <= 1"
              >
                <i class="fas fa-minus text-sm"></i>
              </button>
              <span class="mx-4 w-8 text-center text-lg font-medium text-gray-800" x-text="quantity"></span>
              <button 
                class="w-10 h-10 rounded-full bg-gray-100 text-gray-700 flex items-center justify-center 
                   hover:bg-gray-200 hover:shadow-sm transition-all duration-200 active:scale-95"
                @click="updateQuantity(1)"
                :disabled="selectedVariant.stock > 0 && quantity >= selectedVariant.stock"
              >
                <i class="fas fa-plus text-sm"></i>
              </button>
            </div>
            <button 
              class="flex-1 bg-black text-white py-3 rounded-full font-medium hover:bg-gray-800 transition"
              @click="addToCart"
            >
              Add to cart
            </button>
          </div>
          <button class="flex items-center justify-center space-x-2 border border-gray-300 text-gray-700 py-3 rounded-full font-medium hover:bg-gray-50 transition">
            <i class="far fa-heart"></i>
            <span>Add to Wishlist</span>
          </button>
        </div>

        <div class="flex items-center space-x-4 text-sm">
          <span class="font-medium">Share:</span>
          <button class="text-gray-600 hover:text-blue-600"><i class="fab fa-facebook-f"></i></button>
          <button class="text-gray-600 hover:text-blue-400"><i class="fab fa-twitter"></i></button>
          <div class="ml-auto">
            <button class="text-sm text-gray-500 flex items-center">
              <i class="fas fa-question-circle mr-1"></i> Need help?
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Recommendations -->
    <section class="mt-16 bg-gradient-to-r from-yellow-50 to-orange-50 py-12 rounded-2xl relative">
      <div class="container mx-auto px-4">
        <h2 class="text-3xl font-bold mb-8">You May Also Like</h2>
        <button id="scroll-left" class="absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-white rounded-full p-2 shadow-md hidden md:block opacity-70 hover:opacity-100 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
        </button>
        <button id="scroll-right" class="absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-white rounded-full p-2 shadow-md hidden md:block opacity-70 hover:opacity-100 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
          </svg>
        </button>
        <div id="product-carousel" class="overflow-x-auto pb-4 space-x-4 scrollbar-hide flex">
          <div class="flex space-x-4 min-w-max px-2">
            <% for (let i = 0; i < allproducts.length; i++) { %>
              <div class="bg-white rounded-lg overflow-hidden shadow-sm w-48 flex-shrink-0">
                <a href="/product?product=<%= allproducts[i].productId %>" class="block">
                  <div class="relative">
                    <img src="<%= allproducts[i].variants.images[0] %>" class="w-full h-48 object-contain" />
                  </div>
                  <div class="p-4">
                    <div class="text-xs text-gray-500 mb-1">Casen</div>
                    <div class="text-sm mb-2 truncate"><%= allproducts[i].productName %></div>
                    <div class="flex items-center justify-between">
                      <span class="text-sm font-bold text-red-500"><%= allproducts[i].variants.price %></span>
                    </div>
                  </div>
                </a>
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="bg-black text-white pt-12 pb-8 mt-16">
    <div class="container mx-auto px-4 text-center">
      <p>&copy; 2025 Casen. All rights reserved.</p>
    </div>
  </footer>

  <!-- Add to Cart Modal -->
  <div 
    x-show="showModal" 
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
    @click="showModal = false"
    x-transition
  >
    <div class="bg-white rounded-2xl max-w-md w-full p-6 relative" @click.stop>
      <button @click="showModal = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
        <i class="fas fa-times"></i>
      </button>
      <div class="text-center py-4">
        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-check text-green-600 text-2xl"></i>
        </div>
        <h3 class="text-xl font-bold mb-2">Added to Cart!</h3>
        <p class="text-gray-600 mb-4">
          <span x-text="productName"></span> (<span x-text="selectedVariant.color"></span>)
        </p>
        <div class="flex justify-center space-x-4">
          <button @click="showModal = false" class="px-4 py-2 border border-gray-300 rounded-full text-gray-700 hover:bg-gray-50">
            Continue Shopping
          </button>
          <a href="/cart" class="px-4 py-2 bg-black text-white rounded-full hover:bg-gray-800">
            View Cart
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Alpine.js Logic -->
  <script>
    function productApp(initialData) {
      return {
        productId: initialData.productId,
        productName: initialData.productName,
        categoryName: initialData.categoryName,
        description: initialData.description,
        isLoggedIn: initialData.isLoggedIn, // âœ…
        variants: initialData.variants,

        selectedVariantIndex: 0,
        quantity: 1,
        showModal: false,
        openSections: { description: false, spec: false },

        get selectedVariant() {
          return this.variants[this.selectedVariantIndex] || {};
        },

        init() {
          this.initZoom();
        },

        getColorClass(color) {
          if (!color) return 'color-fallback-gray';
          const c = color.toLowerCase().trim();
          if (c.includes('wine') || c.includes('burgundy')) return 'color-fallback-wine-red';
          if (c.includes('black')) return 'color-fallback-black';
          if (c.includes('white')) return 'color-fallback-white';
          if (c.includes('purple')) return 'color-fallback-purple';
          if (c.includes('red')) return 'color-fallback-red';
          if (c.includes('blue')) return 'color-fallback-blue';
          if (c.includes('green')) return 'color-fallback-green';
          if (c.includes('pink')) return 'color-fallback-pink';
          if (c.includes('orange')) return 'color-fallback-orange';
          if (c.includes('violet') || c.includes('grape')) return 'color-fallback-violet';
          return 'color-fallback-gray';
        },

        selectVariant(index) {
          if (index >= 0 && index < this.variants.length) {
            this.selectedVariantIndex = index;
            this.quantity = 1;
            this.updateMainImage(this.selectedVariant.images[0]);
          }
        },

        updateMainImage(src) {
          const img = document.getElementById('mainImage');
          if (img) img.src = src;
          this.resetZoom();
        },

        updateQuantity(change) {
          if (this.selectedVariant.stock <= 0) return;
          let newQty = this.quantity + change;
          if (newQty < 1) newQty = 1;
          if (newQty > this.selectedVariant.stock) newQty = this.selectedVariant.stock;
          this.quantity = newQty;
        },

        // âœ… Fully updated addToCart
        addToCart() {
          // ðŸ”‘ Check login first
          if (!this.isLoggedIn) {
            Swal.fire({
              icon: 'info',
              title: 'Please Sign In',
              text: 'You need to be logged in to add items to your cart.',
              confirmButtonText: 'Go to Login',
              showCancelButton: true,
              cancelButtonText: 'Cancel'
            }).then((result) => {
              if (result.isConfirmed) {
                window.location.href = '/login';
              }
            });
            return;
          }

          // Check stock
          if (this.selectedVariant.stock <= 0) {
            Swal.fire({
              icon: 'warning',
              title: 'Out of Stock',
              text: 'This item is currently out of stock.',
              confirmButtonText: 'OK'
            });
            return;
          }

          // Show modal
          this.showModal = true;

          // Add to cart
          fetch('/cart/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              productId: this.productId,
              variantId: this.selectedVariant._id,
              quantity: this.quantity
            })
          }).catch(err => {
            console.error('Add to cart failed:', err);
          });
        },

        toggleAccordion(section) {
          this.openSections[section] = !this.openSections[section];
        },

        initZoom() {
          const container = document.getElementById('zoomContainer');
          const img = document.getElementById('mainImage');
          const lens = document.getElementById('zoomLens');
          if (!container || !img || !lens) return;

          const zoomLevel = 2;
          container.addEventListener('mouseenter', () => {
            if (window.innerWidth <= 768) return;
            lens.classList.remove('hidden');
            container.style.cursor = 'none';
          });
          container.addEventListener('mouseleave', () => this.resetZoom());
          container.addEventListener('mousemove', (e) => {
            if (window.innerWidth <= 768) return;
            const rect = container.getBoundingClientRect();
            let x = e.clientX - rect.left;
            let y = e.clientY - rect.top;
            const lensWidth = lens.offsetWidth;
            const lensHeight = lens.offsetHeight;
            let lensX = Math.max(0, Math.min(x - lensWidth / 2, rect.width - lensWidth));
            let lensY = Math.max(0, Math.min(y - lensHeight / 2, rect.height - lensHeight));
            lens.style.left = lensX + 'px';
            lens.style.top = lensY + 'px';
            img.style.transformOrigin = `${x}px ${y}px`;
            img.style.transform = `scale(${zoomLevel})`;
          });
        },

        resetZoom() {
          const img = document.getElementById('mainImage');
          const lens = document.getElementById('zoomLens');
          const container = document.getElementById('zoomContainer');
          if (img) img.style.transform = 'scale(1)';
          if (lens) lens.classList.add('hidden');
          if (container) container.style.cursor = 'zoom-in';
        }
      };
    }

    // Carousel logic
    document.addEventListener('DOMContentLoaded', () => {
      const carousel = document.getElementById('product-carousel');
      const scrollLeftBtn = document.getElementById('scroll-left');
      const scrollRightBtn = document.getElementById('scroll-right');
      const scrollAmount = 300;

      if (carousel && scrollLeftBtn && scrollRightBtn) {
        const updateButtonVisibility = () => {
          const maxScroll = carousel.scrollWidth - carousel.clientWidth;
          scrollLeftBtn.classList.toggle('hidden', carousel.scrollLeft <= 0);
          scrollRightBtn.classList.toggle('hidden', carousel.scrollLeft >= maxScroll - 1);
        };
        updateButtonVisibility();
        scrollLeftBtn.addEventListener('click', () => carousel.scrollBy({ left: -scrollAmount, behavior: 'smooth' }));
        scrollRightBtn.addEventListener('click', () => carousel.scrollBy({ left: scrollAmount, behavior: 'smooth' }));
        carousel.addEventListener('scroll', updateButtonVisibility);
      }
    });
  </script>
</body>
</html>