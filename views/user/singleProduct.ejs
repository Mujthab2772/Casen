<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" sizes="32x32" href="/logoTab.png">
  <title><%= product.productName %> - Casen</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* Fallback for unknown colors */
    .color-fallback-black { background-color: #000; }
    .color-fallback-white { background-color: #fff; border: 1px solid #ccc; }
    .color-fallback-wine-red { background-color: #722F37; }
    .color-fallback-red { background-color: #ef4444; }
    .color-fallback-blue { background-color: #3b82f6; }
    .color-fallback-green { background-color: #10b981; }
    .color-fallback-pink { background-color: #ec4899; }
    .color-fallback-orange { background-color: #f97316; }
    .color-fallback-purple { background-color: #a855f7; }
    .color-fallback-gray { background-color: #9ca3af; }
    .color-fallback-violet { background-color: #8a2be2; } 

    #zoomContainer {
      cursor: zoom-in;
      touch-action: none;
      position: relative;
      overflow: hidden;
    }
    #zoomLens {
      border: 1px solid rgba(255, 255, 255, 0.5);
      background-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      position: absolute;
      pointer-events: none; /* Crucial: lets mouse events pass through to container */
    }
  </style>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.10/dist/cdn.min.js"></script>
</head>
<body class="bg-white text-gray-800 font-sans">

  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <!-- Logo -->
      <div class="flex items-center">
        <a href="/">
          <img src="/logo.png" alt="Logo" class="h-8 object-contain">
        </a>
      </div>

      <!-- Desktop Navigation -->
      <nav class="hidden md:flex space-x-5">
        <a href="/" class="text-sm font-medium transition-opacity hover:opacity-80">Home</a>
        <a href="#" class="text-sm font-medium transition-opacity hover:opacity-80">About</a>
        <a href="/products" class="text-sm font-medium transition-opacity hover:opacity-80">Phone Cases</a>
        <a href="#" class="text-sm font-medium transition-opacity hover:opacity-80">Tablet Cases</a>
        <a href="#" class="text-sm font-medium transition-opacity hover:opacity-80">Sale</a>
      </nav>

      <!-- Icons & Auth -->
      <div class="flex items-center space-x-4">
        <!-- Wishlist -->
        <button class="p-2 rounded-full hover:bg-gray-100 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
          </svg>
        </button>

        <!-- Cart -->
        <button class="p-2 rounded-full hover:bg-gray-100 transition-colors relative">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
        </button>

        <!-- User Menu -->
        <% if (locals.user && user.profilePic) { %>
        <div class="relative" x-data="{ open: false }" @click.away="open = false">
          <button @click="open = !open" class="rounded-full overflow-hidden w-8 h-8 border border-transparent hover:border-gray-300 transition-colors focus:outline-none">
            <img src="<%= user.profilePic %>" alt="Profile" class="w-full h-full object-cover" />
          </button>
          <div x-show="open"
               x-transition:enter="transition ease-out duration-150"
               x-transition:enter-start="opacity-0 scale-95"
               x-transition:enter-end="opacity-100 scale-100"
               x-transition:leave="transition ease-in duration-100"
               x-transition:leave-start="opacity-100 scale-100"
               x-transition:leave-end="opacity-0 scale-95"
               class="absolute right-0 mt-2 w-44 bg-white shadow-lg rounded-lg py-1 z-50">
            <a href="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">Profile</a>
            <form action="/logout" method="post">
              <button type="submit" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">Logout</button>
            </form>
          </div>
        </div>

        <% } else if (locals.user) { %>
        <div class="relative" x-data="{ open: false }" @click.away="open = false">
          <button @click="open = !open" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:text-gray-900 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
          </button>
          <div x-show="open"
               x-transition:enter="transition ease-out duration-150"
               x-transition:enter-start="opacity-0 scale-95"
               x-transition:enter-end="opacity-100 scale-100"
               x-transition:leave="transition ease-in duration-100"
               x-transition:leave-start="opacity-100 scale-100"
               x-transition:leave-end="opacity-0 scale-95"
               class="absolute right-0 mt-2 w-44 bg-white shadow-lg rounded-lg py-1 z-50">
            <a href="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Profile</a>
            <form action="/logout" method="post">
              <button type="submit" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Logout</button>
            </form>
          </div>
        </div>

        <% } else { %>
        <a href="/login" class="text-sm font-medium hover: transition-colors flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          Sign In
        </a>
        <% } %>

        <!-- Mobile Menu Button -->
        <button class="md:hidden text-gray-600 hover:text-gray-900">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="container mx-auto px-4 mt-4">
    <ol class="flex items-center space-x-2 text-sm text-gray-500">
      <li><a href="/" class="hover:text-gray-700">Home</a></li>
      <li><span class="mx-1">/</span></li>
      <li><a href="/products" class="hover:text-gray-700">Products</a></li>
      <li><span class="mx-1">/</span></li>
      <li class="text-gray-900"><%= product.productName %></li>
    </ol>
  </nav>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      
      <!-- Product Image Gallery -->
      <div class="space-y-3">
        <!-- Main Image Container with Zoom -->
        <div class="relative w-full aspect-square bg-gray-100 rounded-lg overflow-hidden group" id="zoomContainer">
          <img 
            id="mainImage" 
            src="<%= product.variants.length > 0 ? (product.variants[0].images && product.variants[0].images[0] ? product.variants[0].images[0] : 'https://placehold.co/600x600?text=No+Image') : 'https://placehold.co/600x600?text=No+Variants' %>" 
            alt="<%= product.productName %>" 
            class="w-full h-full object-contain transition-transform duration-200 ease-out"
          />
          <!-- Zoom lens -->
          <div id="zoomLens" class="hidden w-32 h-32 rounded-full absolute top-0 left-0"></div>
        </div>

        <!-- Thumbnail Gallery -->
        <div id="thumbnailGallery" class="flex space-x-2 overflow-x-auto pb-1"></div>

        <!-- Color Selection -->
        <div class="bg-gray-50 p-4 rounded-lg">
          <h3 class="font-semibold mb-3">Color - <span id="selectedColor"><%= product.variants.length > 0 ? product.variants[0].color : 'N/A' %></span></h3>
          <div class="flex space-x-3" id="colorOptions">
            <% product.variants.forEach((variant, index) => { 
                const colorLower = variant.color.toLowerCase();
                let fallbackClass = 'color-fallback-gray';
                if (colorLower.includes('wine') || colorLower.includes('burgundy')) fallbackClass = 'color-fallback-wine-red';
                else if (colorLower.includes('black')) fallbackClass = 'color-fallback-black';
                else if (colorLower.includes('white')) fallbackClass = 'color-fallback-white';
                else if (colorLower.includes('purple')) fallbackClass = 'color-fallback-purple';
                else if (colorLower.includes('red')) fallbackClass = 'color-fallback-red';
                else if (colorLower.includes('blue')) fallbackClass = 'color-fallback-blue';
                else if (colorLower.includes('green')) fallbackClass = 'color-fallback-green';
                else if (colorLower.includes('pink')) fallbackClass = 'color-fallback-pink';
                else if (colorLower.includes('orange')) fallbackClass = 'color-fallback-orange';
                else if (colorLower.includes('grape') || colorLower.includes('violet')) fallbackClass = 'color-fallback-violet';
            %>
              <div 
                class="w-10 h-10 rounded-full cursor-pointer border-2 <%= index === 0 ? 'border-blue-500' : 'border-transparent' %> <%= fallbackClass %>"
                data-color="<%= variant.color %>"
                data-price="<%= variant.price %>"
                data-stock="<%= variant.stock %>"
                data-images='<%= JSON.stringify(variant.images && variant.images.length ? variant.images : ["https://placehold.co/600x600?text=No+Image"]) %>'
                onclick="selectVariant(this)"
              ></div>
            <% }); %>
          </div>
        </div>
      </div>

      <!-- Product Details -->
      <div class="space-y-6">
        <div>
          <p class="text-sm text-gray-500"><%= product.category.categoryName %></p>
          <p class="text-sm text-gray-500"><%= product.productName %></p>
          <h1 class="text-2xl font-bold mt-1"><%= product.variants.length > 0 ? product.variants[0].color : '' %></h1>
        </div>

        <div class="flex items-center space-x-2 text-sm text-orange-500">
          <i class="fas fa-fire"></i>
          <span>153+ bought in past month</span>
        </div>

        <div class="flex items-center space-x-4">
          <span class="text-xl font-bold text-red-500" id="price">
            Rs. <%= product.variants.length > 0 ? product.variants[0].price : '0' %>.00
          </span>
        </div>

        <div class="inline-flex items-center px-3 py-1 rounded-full text-sm" id="stockStatus">
          <% const firstVariant = product.variants[0]; %>
          <% if (firstVariant && firstVariant.stock > 0) { %>
            <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
            In stock (<%= firstVariant.stock %> available)
          <% } else { %>
            Out of stock
          <% } %>
        </div>

        <!-- Description Accordion -->
        <div class="border-t border-gray-200 pt-4">
          <div class="flex justify-between items-center cursor-pointer" onclick="toggleAccordion('description')">
            <h3 class="font-semibold">Description</h3>
            <i id="descIcon" class="fas fa-chevron-down text-sm"></i>
          </div>
          <div id="description" class="mt-3 text-sm text-gray-600 hidden">
            <p><%= product.description || 'No description available.' %></p>
          </div>
        </div>

        <!-- Tech Spec Accordion -->
        <div class="border-t border-gray-200 pt-4">
          <div class="flex justify-between items-center cursor-pointer" onclick="toggleAccordion('spec')">
            <h3 class="font-semibold">Technical Specification</h3>
            <i id="specIcon" class="fas fa-chevron-down text-sm"></i>
          </div>
          <div id="spec" class="mt-3 text-sm text-gray-600 hidden">
            <div class="mb-3">
              <h4 class="font-medium mb-1">Material:</h4>
              <p><%= product.category?.categoryName || 'N/A' %></p>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex flex-col space-y-3">
          <div class="flex items-center space-x-4">
            <div class="flex items-center border border-gray-300 rounded-full">
              <button class="px-3 py-1 text-gray-600 hover:bg-gray-100" onclick="updateQuantity(-1)">-</button>
              <span class="px-3 py-1" id="quantity">1</span>
              <button class="px-3 py-1 text-gray-600 hover:bg-gray-100" onclick="updateQuantity(1)">+</button>
            </div>
            <button class="flex-1 bg-black text-white py-3 rounded-full font-medium hover:bg-gray-800 transition">
              Add to cart
            </button>
          </div>
          <button class="flex items-center justify-center space-x-2 border border-gray-300 text-gray-700 py-3 rounded-full font-medium hover:bg-gray-50 transition">
            <i class="far fa-heart"></i>
            <span>Add to Wishlist</span>
          </button>
        </div>

        <!-- Share -->
        <div class="flex items-center space-x-4 text-sm">
          <span class="font-medium">Share:</span>
          <button class="text-gray-600 hover:text-blue-600"><i class="fab fa-facebook-f"></i></button>
          <button class="text-gray-600 hover:text-blue-400"><i class="fab fa-twitter"></i></button>
          <div class="ml-auto">
            <button class="text-sm text-gray-500 flex items-center">
              <i class="fas fa-question-circle mr-1"></i> Need help?
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Recommendations -->
    <section class="mt-16 bg-gradient-to-r from-yellow-50 to-orange-50 py-12 rounded-2xl">
      <div class="container mx-auto px-4">
        <h2 class="text-3xl font-bold mb-8">You May Also Like</h2>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-6">
          <% for (let i = 0; i < allproducts.length && i < 6; i++) { %>
            <div class="bg-white rounded-lg overflow-hidden shadow-sm">
              <a href="/product?product=<%= allproducts[i].productId %>" class="block">
                <div class="relative">
                  <img src="<%= allproducts[i].variants.images[0] %>" class="w-full h-48 object-contain" />
                </div>
                <div class="p-4">
                  <div class="text-xs text-gray-500 mb-1">Casen</div>
                  <div class="text-sm mb-2"><%= allproducts[i].productName %></div>
                  <div class="flex items-center justify-between">
                    <span class="text-sm font-bold text-red-500"><%= allproducts[i].variants.price %></span>
                  </div>
                </div>
              </a>
            </div>
          <% } %>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-black text-white pt-12 pb-8 mt-16">
    <div class="container mx-auto px-4 text-center">
      <p>&copy; 2025 Casen. All rights reserved.</p>
    </div>
  </footer>

  <!-- CONSOLIDATED SCRIPTS -->
  <script>
    /* Global Variables */
    let currentQuantity = 1;

    /* Initialize on DOM Ready */
    document.addEventListener('DOMContentLoaded', () => {
      // 1. Initialize Zoom Logic
      initImageZoom();

      // 2. Select the first variant by default (to populate thumbnails/price)
      const firstVariant = document.querySelector('#colorOptions > div');
      if (firstVariant) {
        selectVariant(firstVariant);
      }
    });

    /* --- Variant Selection Logic --- */
    function selectVariant(el) {
      // Highlight selected color
      document.querySelectorAll('#colorOptions > div').forEach(d => {
        d.classList.remove('border-blue-500');
        d.classList.add('border-transparent');
      });
      el.classList.remove('border-transparent');
      el.classList.add('border-blue-500');

      // Get Data
      const color = el.getAttribute('data-color');
      const price = el.getAttribute('data-price');
      const stock = parseInt(el.getAttribute('data-stock'));
      const images = JSON.parse(el.getAttribute('data-images'));

      // Update Main Image
      const mainImage = document.getElementById('mainImage');
      const newSrc = images[0] || 'https://placehold.co/600x600?text=No+Image';
      mainImage.src = newSrc;

      // *** RESET ZOOM STATE ***
      // This fixes the issue where zoom breaks after switching images
      resetZoomState();

      // Update Text Info
      document.getElementById('selectedColor').textContent = color;
      document.getElementById('price').textContent = 'Rs. ' + price + '.00';

      // Update Stock Status
      const stockEl = document.getElementById('stockStatus');
      if (stock > 0) {
        stockEl.innerHTML = `<div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div> In stock (${stock} available)`;
        stockEl.className = "inline-flex items-center px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm";
      } else {
        stockEl.textContent = "Out of stock";
        stockEl.className = "inline-flex items-center px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm";
      }

      // Reset Quantity
      currentQuantity = 1;
      document.getElementById('quantity').textContent = currentQuantity;

      // Update Thumbnail Gallery
      const thumbnailContainer = document.getElementById('thumbnailGallery');
      thumbnailContainer.innerHTML = ''; // Clear existing

      const thumbnails = images.slice(0, 5);
      if (thumbnails.length > 0) {
        thumbnails.forEach(imgSrc => {
          const thumb = document.createElement('img');
          thumb.src = imgSrc;
          thumb.alt = 'Thumbnail';
          thumb.className = 'w-16 h-16 object-cover border border-gray-300 rounded cursor-pointer flex-shrink-0 hover:border-blue-500 transition';
          thumb.onclick = () => {
            mainImage.src = imgSrc;
            resetZoomState(); // Reset zoom when thumbnail clicks change image
          };
          thumbnailContainer.appendChild(thumb);
        });
      }
    }

    /* --- Quantity Logic --- */
    function updateQuantity(change) {
      const activeVariant = document.querySelector('#colorOptions .border-blue-500');
      // If no variant selected, assume 1 as max for safety, or just allow infinite
      const maxStock = activeVariant ? parseInt(activeVariant.getAttribute('data-stock')) : 100;
      
      currentQuantity += change;
      
      // Clamp values
      if (currentQuantity < 1) currentQuantity = 1;
      if (activeVariant && currentQuantity > maxStock) currentQuantity = maxStock;

      document.getElementById('quantity').textContent = currentQuantity;
    }

    /* --- Accordion Logic --- */
    function toggleAccordion(id) {
      const content = document.getElementById(id);
      const icon = document.getElementById(id + 'Icon');
      if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
      } else {
        content.classList.add('hidden');
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
      }
    }

    /* --- Image Zoom Logic --- */
    function initImageZoom() {
      const container = document.getElementById('zoomContainer');
      const img = document.getElementById('mainImage');
      const lens = document.getElementById('zoomLens');

      if (!container || !img || !lens) return;

      const zoomLevel = 2; // How much to scale

      // Mouse Enter: Show lens, hide cursor
      container.addEventListener('mouseenter', () => {
        // Disable zoom on mobile
        if (window.innerWidth <= 768) return;
        lens.classList.remove('hidden');
        container.style.cursor = 'none';
      });

      // Mouse Leave: Reset
      container.addEventListener('mouseleave', () => {
        resetZoomState();
      });

      // Mouse Move: Calculate positions
      container.addEventListener('mousemove', (e) => {
        if (window.innerWidth <= 768) return;

        const rect = container.getBoundingClientRect();
        
        // Calculate mouse position relative to container
        let x = e.clientX - rect.left;
        let y = e.clientY - rect.top;

        // Lens dimensions
        const lensWidth = lens.offsetWidth;
        const lensHeight = lens.offsetHeight;

        // Prevent lens from going out of bounds
        // (Visual positioning of the square lens)
        let lensX = x - (lensWidth / 2);
        let lensY = y - (lensHeight / 2);

        // Boundary checks for the lens box
        if (lensX < 0) lensX = 0;
        if (lensX > rect.width - lensWidth) lensX = rect.width - lensWidth;
        if (lensY < 0) lensY = 0;
        if (lensY > rect.height - lensHeight) lensY = rect.height - lensHeight;

        lens.style.left = lensX + 'px';
        lens.style.top = lensY + 'px';

        // Transform the image
        // transform-origin is key here: it needs to be the mouse position
        img.style.transformOrigin = `${x}px ${y}px`;
        img.style.transform = `scale(${zoomLevel})`;
      });
    }

    /* Helper to reset zoom (used by init, selectVariant, and thumbnail click) */
    function resetZoomState() {
      const img = document.getElementById('mainImage');
      const lens = document.getElementById('zoomLens');
      const container = document.getElementById('zoomContainer');

      if (img) {
        img.style.transform = 'scale(1)';
        img.style.transformOrigin = 'center center';
      }
      if (lens) {
        lens.classList.add('hidden');
      }
      if (container) {
        container.style.cursor = 'zoom-in';
      }
    }
  </script>
</body>
</html>