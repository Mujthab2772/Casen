<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Add New Address</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>
<body class="bg-gray-50">

  <!-- Header (Exactly as provided) -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <!-- Logo -->
      <div class="flex items-center">
        <a href="/">
          <img src="/logo.png" alt="Logo" class="h-8 object-contain">
        </a>
      </div>

      <!-- Desktop Navigation -->
      <nav class="hidden md:flex space-x-5">
        <a href="/" class="text-sm font-medium transition-opacity hover:opacity-80">Home</a>
        <a href="#" class="text-sm font-medium transition-opacity hover:opacity-80">About</a>
        <a href="/products" class="text-sm font-medium transition-opacity hover:opacity-80">Phone Cases</a>
        <a href="#" class="text-sm font-medium transition-opacity hover:opacity-80">Tablet Cases</a>
        <a href="#" class="text-sm font-medium transition-opacity hover:opacity-80">Sale</a>
      </nav>

      <!-- Icons & Auth -->
      <% if (locals.user && user.profilePic) { %>
      <div class="relative" x-data="{ open: false }" @click.away="open = false">
        <button @click="open = !open" class="rounded-full overflow-hidden w-8 h-8 border border-transparent hover:border-gray-300 transition-colors focus:outline-none">
          <img src="<%= user.profilePic %>" alt="Profile" class="w-full h-full object-cover" />
        </button>
        <div x-show="open"
             x-transition:enter="transition ease-out duration-150"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-100"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             class="absolute right-0 mt-2 w-44 bg-white shadow-lg rounded-lg py-1 z-50">
          <a href="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">Profile</a>
          <form action="/logout" method="post">
            <button type="submit" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">Logout</button>
          </form>
        </div>
      </div>

      <% } else if (locals.user) { %>
      <div class="relative" x-data="{ open: false }" @click.away="open = false">
        <button @click="open = !open" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:text-gray-900 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </button>
        <div x-show="open"
             x-transition:enter="transition ease-out duration-150"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-100"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             class="absolute right-0 mt-2 w-44 bg-white shadow-lg rounded-lg py-1 z-50">
          <a href="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Profile</a>
          <form action="/logout" method="post">
            <button type="submit" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Logout</button>
          </form>
        </div>
      </div>

      <% } else { %>
      <a href="/login" class="text-sm font-medium text-red-600 hover:text-red-700 transition-colors flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
        Sign In
      </a>
      <% } %>

      <!-- Mobile Menu Button -->
      <button class="md:hidden text-gray-600 hover:text-gray-900">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container mx-auto px-4 py-8 flex flex-col lg:flex-row gap-6">

    <!-- Sidebar (Exactly as provided) -->
    <aside class="lg:w-60 bg-white rounded-xl shadow-sm overflow-hidden">
      <nav class="p-4 space-y-1">
        <a href="/profile" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
          <i class="fas fa-user text-sm"></i>
          <span class="font-medium text-sm">Profile</span>
        </a>
        <a href="/profile/orders" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
          <i class="fas fa-shopping-cart text-sm"></i>
          <span class="font-medium text-sm">Orders</span>
        </a>
        <a href="/profile/wishlist" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
          <i class="far fa-heart text-sm"></i>
          <span class="font-medium text-sm">Wishlist</span>
        </a>
        <a href="/profile/address" class="flex items-center space-x-3 px-4 py-3 bg-black text-white rounded-lg transition-colors">
          <i class="fas fa-home text-sm"></i>
          <span class="font-medium text-sm">Address</span>
        </a>
        <a href="/profile/newPassword" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
          <i class="fas fa-lock text-sm"></i>
          <span class="font-medium text-sm">Password</span>
        </a>
        <a href="/profile/wallet" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
          <i class="fas fa-wallet text-sm"></i>
          <span class="font-medium text-sm">Wallet</span>
        </a>
        <a href="/profile/referral" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
          <i class="fas fa-users text-sm"></i>
          <span class="font-medium text-sm">Referral</span>
        </a>
        <a href="#" onclick="document.getElementById('logout-form').submit();" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors mt-4">
          <i class="fas fa-sign-out-alt text-sm"></i>
          <span class="font-medium text-sm">Logout</span>
        </a>
        <form id="logout-form" action="/logout" method="post" class="hidden"></form>
      </nav>
    </aside>

    <!-- Add New Address Form -->
    <main class="flex-1">
      <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-sm">
        <div class="flex justify-between items-center mb-6">
          <h1 class="text-3xl font-bold text-gray-900">Add New Address</h1>
          <button class="text-gray-500 hover:text-gray-700" onclick="window.location.href='/profile/address'">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <form id="addressForm" class="space-y-6">
          <!-- Full Name -->
          <div>
            <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
            <input type="text" name="fullName" id="fullName" placeholder="Enter your full name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent outline-none transition">
            <p class="mt-1 text-sm text-red-600 error-message" id="error-fullName"></p>
          </div>

          <!-- Street Address -->
          <div>
            <label for="streetAddress" class="block text-sm font-medium text-gray-700 mb-1">Street Address</label>
            <input type="text" name="streetAddress" id="streetAddress" placeholder="Enter your street address" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent outline-none transition">
            <p class="mt-1 text-sm text-red-600 error-message" id="error-streetAddress"></p>
          </div>

          <!-- Phone Number -->
          <div>
            <label for="phoneNumber" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
            <input type="tel" name="mobile" id="phoneNumber" placeholder="Enter your phone number" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent outline-none transition">
            <p class="mt-1 text-sm text-red-600 error-message" id="error-mobile"></p>
          </div>

          <!-- City & State/Province -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="city" class="block text-sm font-medium text-gray-700 mb-1">City</label>
              <input type="text" name="city" id="city" placeholder="Enter your city" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent outline-none transition">
              <p class="mt-1 text-sm text-red-600 error-message" id="error-city"></p>
            </div>
            <div>
              <label for="state" class="block text-sm font-medium text-gray-700 mb-1">State/Province</label>
              <input type="text" name="state" id="state" placeholder="Enter your state or province" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent outline-none transition">
              <p class="mt-1 text-sm text-red-600 error-message" id="error-state"></p>
            </div>
          </div>

          <!-- Postal Code & Country -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="postalCode" class="block text-sm font-medium text-gray-700 mb-1">Postal Code</label>
              <input type="text" name="postalcode" id="postalCode" placeholder="Enter your postal code" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent outline-none transition">
              <p class="mt-1 text-sm text-red-600 error-message" id="error-postalcode"></p>
            </div>
            <div class="relative">
              <label for="country" class="block text-sm font-medium text-gray-700 mb-1">Country</label>
              <select id="country" name="country" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent outline-none transition appearance-none">
                <option value="" disabled selected>Select your country</option>
                <option>United States</option>
                <option>Canada</option>
                <option>United Kingdom</option>
                <option>Australia</option>
                <option>Germany</option>
                <option>France</option>
                <option>Japan</option>
                <option>India</option>
              </select>
              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </div>
              <p class="mt-1 text-sm text-red-600 error-message" id="error-country"></p>
            </div>
          </div>

          <!-- Default Shipping Checkbox -->
          <div class="flex items-start">
            <div class="flex items-center h-5">
              <input id="defaultShipping" type="checkbox" name="defaultOption" class="w-4 h-4 border border-gray-300 rounded focus:ring-2 focus:ring-black focus:ring-offset-2">
            </div>
            <div class="ml-3 text-sm">
              <label for="defaultShipping" class="font-medium text-gray-700">Make this my default shipping address.</label>
            </div>
          </div>

          <!-- Save & Cancel Buttons -->
          <div class="flex flex-col sm:flex-row gap-3 pt-4">
            <button type="submit" class="w-full sm:w-auto px-6 py-3 bg-black text-white font-medium rounded-lg hover:bg-gray-800 transition-colors">
              Add Address
            </button>
            <button type="button" class="w-full sm:w-auto px-6 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors" onclick="window.location.href='/profile/address'">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </main>

  </div>

  <!-- Alpine.js -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    document.getElementById('addressForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      // Clear previous errors
      document.querySelectorAll('.error-message').forEach(el => el.textContent = '');

      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());

      try {
        const response = await fetch('/profile/addAddress?userId=<%= user._id %>', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok) {
          // ✅ Success
          await Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: 'Address saved successfully!',
            confirmButtonText: 'OK',
            customClass: {
              confirmButton: 'bg-black text-white hover:bg-gray-800 px-6 py-2 rounded-lg'
            },
            buttonsStyling: false
          });
          window.location.href = '/profile/address';

        } else if (response.status === 400 && result.errors) {
          // ❌ Validation errors
          result.errors.forEach(err => {
            const field = err.path; // e.g., "postalcode"
            const errorEl = document.getElementById(`error-${field}`);
            if (errorEl) errorEl.textContent = err.msg;
          });

        } else {
          // ❌ Other backend errors
          await Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: result.msg || 'Failed to save address.',
            confirmButtonText: 'Try Again'
          });
        }

      } catch (error) {
        console.error('Error:', error);
        await Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'An error occurred while saving.',
          confirmButtonText: 'OK'
        });
      }
    });
  </script>

</body>
</html>