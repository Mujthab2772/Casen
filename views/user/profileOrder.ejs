<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Orders</title>
    <!-- CDN Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.10/dist/cdn.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        /* Base Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        
        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #printable-order {
                visibility: visible;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            #printable-order * {
                visibility: visible;
            }
        }
        
        /* Order Item Cards */
        .order-item-card {
            transition: all 0.2s ease;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        .order-item-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateY(-1px);
        }
        .cancelled-item {
            opacity: 0.7;
            background-color: #fef2f2;
        }
        .return-requested-item {
            opacity: 0.8;
            background-color: #fffbeb;
            border-left: 3px solid #f59e0b;
        }
        .returned-item {
            opacity: 0.7;
            background-color: #dcfce7;
            border-left: 3px solid #16a34a;
        }
        
        /* Order Details Container */
        .order-details-container {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        /* Summary Section */
        .summary-section {
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-top: 1.5rem;
        }
        .summary-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #1f2937;
            font-weight: 600;
            font-size: 1.125rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.75rem 1rem;
        }
        .summary-label {
            color: #4b5563;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }
        .summary-value {
            font-weight: 500;
            text-align: right;
        }
        .summary-subtotal { color: #374151; }
        .summary-discount { color: #ef4444; }
        .summary-tax { color: #8b5cf6; }
        .summary-shipping { color: #0ea5e9; }
        .summary-total {
            display: flex;
            justify-content: space-between;
            padding-top: 1.25rem;
            margin-top: 1rem;
            border-top: 2px solid #374151;
            font-weight: bold;
            font-size: 1.25rem;
            color: #111827;
        }
        
        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .status-delivered { background-color: #dcfce7; color: #15803d; }
        .status-pending,
        .status-processing,
        .status-active { background-color: #dbeafe; color: #1d4ed8; }
        .status-shipped { background-color: #ede9fe; color: #6d28d9; }
        .status-cancelled { background-color: #fee2e2; color: #b91c1c; }
        .status-returned,
        .status-return-requested,
        .status-requestingReturn { background-color: #fef3c7; color: #b45309; }
        .payment-status-paid { background-color: #dcfce7; color: #15803d; }
        .payment-status-pending { background-color: #fef3c7; color: #b45309; }
        .payment-status-failed { background-color: #fee2e2; color: #b91c1c; }
        
        /* Address Card */
        .address-card {
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }
        .address-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateY(-2px);
        }
        .address-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1rem;
        }
        .address-title {
            font-weight: 600;
            font-size: 1.125rem;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .address-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background-color: #10b981;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .address-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .address-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }
        .address-icon-container {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #10b981;
        }
        .address-text {
            font-size: 0.95rem;
            color: #374151;
            line-height: 1.5;
        }
        .address-label {
            font-weight: 500;
            color: #4b5563;
        }
        .contact-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            background-color: #eff6ff;
            color: #1d4ed8;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: 0.25rem;
        }
        
        /* Invoice Styles */
        .invoice-container {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.5;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .invoice-header {
            text-align: center;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .invoice-logo {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
        }
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .invoice-table th,
        .invoice-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .invoice-table th {
            font-weight: 600;
            color: #4b5563;
            background-color: #f9fafb;
        }
        .invoice-footer {
            margin-top: 40px;
            text-align: center;
            color: #6b7280;
            font-size: 14px;
            border-top: 1px solid #e5e7eb;
            padding-top: 20px;
        }
        .print-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Return Status Badges */
        .cancelled-badge {
            display: inline-block;
            background-color: #fee2e2;
            color: #b91c1c;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 12px;
            margin-top: 4px;
        }
        .return-requested-badge {
            display: inline-block;
            background-color: #fef3c7;
            color: #b45309;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 12px;
            margin-top: 4px;
        }
        .returned-badge {
            display: inline-block;
            background-color: #dcfce7;
            color: #15803d;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 12px;
            margin-top: 4px;
        }
        .requesting-return-badge {
            display: inline-block;
            background-color: #ffedd5;
            color: #c2410c;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 12px;
            margin-top: 4px;
        }
        
        /* Beautiful Dropdown Styles */
        .beautiful-dropdown-container {
            position: relative;
            width: 100%;
            margin: 10px 0;
        }
        .beautiful-dropdown {
            position: relative;
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }
        .dropdown-selected {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 14px 18px;
            border: 1.5px solid #d1d5db;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            color: #374151;
            font-weight: 500;
        }
        .dropdown-selected:hover, 
        .dropdown-selected:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .dropdown-selected.empty {
            color: #9ca3af;
        }
        .dropdown-selected.focused {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .dropdown-icon {
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), color 0.2s ease;
        }
        .dropdown-open .dropdown-icon {
            transform: rotate(180deg);
            color: #3b82f6;
        }
        .dropdown-menu {
            position: absolute;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            border-radius: 12px;
            background-color: white;
            border: 1px solid #e0e3e7;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            z-index: 100;
            margin-top: 8px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.25s cubic-bezier(0.165, 0.84, 0.44, 1);
            padding: 8px 0;
        }
        .dropdown-open .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 0.95rem;
            gap: 12px;
        }
        .dropdown-item i {
            width: 20px;
            font-size: 16px;
            opacity: 0.8;
        }
        .dropdown-item:hover {
            background-color: #f8fafc;
            transform: translateX(4px);
        }
        .dropdown-item.selected {
            background-color: #ebf5ff;
            position: relative;
            font-weight: 500;
            color: #1e40af;
        }
        .dropdown-item.selected i {
            color: #3b82f6;
            opacity: 1;
        }
        .dropdown-item.selected::after {
            content: '';
            position: absolute;
            right: 16px;
            width: 8px;
            height: 8px;
            background-color: #3b82f6;
            border-radius: 50%;
            opacity: 0.9;
        }
        .dropdown-divider {
            height: 1px;
            background-color: #e5e7eb;
            margin: 4px 0;
        }
        .dropdown-placeholder {
            color: #9ca3af;
            font-style: italic;
        }
        
        /* Custom Scrollbar */
        .dropdown-menu::-webkit-scrollbar {
            width: 8px;
        }
        .dropdown-menu::-webkit-scrollbar-track {
            background: #f9fafc;
            border-radius: 4px;
            margin: 4px 0;
        }
        .dropdown-menu::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
            border: 2px solid #f9fafc;
        }
        .dropdown-menu::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Animation for dropdown items */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .dropdown-item {
            animation: fadeIn 0.2s ease forwards;
            animation-delay: calc(var(--item-index) * 0.03s);
        }
        
        /* Other reason textarea */
        #other-reason-container textarea {
            transition: all 0.2s ease;
            border-radius: 10px;
            padding: 14px;
        }
        #other-reason-container textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        /* Error message styling */
        .return-error {
            color: #ef4444;
            font-size: 0.85rem;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            animation: shake 0.3s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }
        
        /* Floating label for dropdown */
        .dropdown-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
            font-size: 0.92rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .dropdown-label .required {
            color: #ef4444;
        }
        
        /* Instruction text */
        .dropdown-instruction {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 4px;
            margin-left: 2px;
        }
        
        /* Selected reason preview */
        .reason-preview {
            margin-top: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 3px solid #3b82f6;
            font-size: 0.9rem;
            color: #334155;
            transition: all 0.2s ease;
            display: none;
        }
        .reason-preview.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        .reason-preview-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Search input for dropdown */
        .dropdown-search-container {
            padding: 0 12px 10px;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 8px;
            display: none;
        }
        .dropdown-search-container.show {
            display: block;
        }
        .dropdown-search {
            width: 100%;
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        .dropdown-search:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .dropdown-no-results {
            padding: 12px 20px;
            color: #94a3b8;
            text-align: center;
            font-style: italic;
            font-size: 0.9rem;
        }
        
        /* Focus state for accessibility */
        .dropdown-item:focus {
            outline: none;
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        /* Responsive adjustments */
        @media (max-width: 640px) {
            .dropdown-menu {
                max-height: 220px;
            }
            .dropdown-item {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <!-- Logo -->
            <div class="flex items-center">
                <a href="/">
                    <img src="/logo.png" alt="Logo" class="h-8 object-contain">
                </a>
            </div>
            
            <!-- Desktop Navigation -->
            <nav class="hidden md:flex space-x-5">
                <a href="/" class="text-sm font-medium transition-opacity hover:opacity-80">Home</a>
                <a href="/about" class="text-sm font-medium transition-opacity hover:opacity-80">About</a>
                <a href="/products" class="text-sm font-medium transition-opacity hover:opacity-80">Phone Cases</a>
                <a href="#" class="text-sm font-medium transition-opacity hover:opacity-80">Tablet Cases</a>
                <a href="/products" class="text-sm font-medium transition-opacity hover:opacity-80">Sale</a>
            </nav>
            
            <!-- Icons & Auth -->
            <div class="flex items-center space-x-4">
                <!-- Wishlist -->
                <button class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" onclick="window.location.href='/profile/wishlist'">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                    </svg>
                </button>
                
                <!-- Cart -->
                <button class="p-2 rounded-full hover:bg-gray-100 transition-colors relative" onclick="window.location.href='/cart'">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                </button>
                
                <!-- User Menu -->
                <% if (locals.user && user.profilePic) { %>
                    <div class="relative" x-data="{ open: false, imageError: false }" @click.away="open = false">
                        <button @click="open = !open" class="rounded-full overflow-hidden w-8 h-8 border border-transparent hover:border-gray-300 transition-colors focus:outline-none">
                            <template x-if="!imageError">
                                <img src="<%= user.profilePic %>" @error="imageError = true" alt="Profile" class="w-full h-full object-cover" />
                            </template>
                            <template x-if="imageError">
                                <div class="w-full h-full bg-gray-300 flex items-center justify-center text-gray-600 rounded-full">
                                    <span class="font-medium text-sm"><%= user.name ? user.name.charAt(0).toUpperCase() : 'U' %></span>
                                </div>
                            </template>
                        </button>
                        <div x-show="open"
                            x-transition:enter="transition ease-out duration-150"
                            x-transition:enter-start="opacity-0 scale-95"
                            x-transition:enter-end="opacity-100 scale-100"
                            x-transition:leave="transition ease-in duration-100"
                            x-transition:leave-start="opacity-100 scale-100"
                            x-transition:leave-end="opacity-0 scale-95"
                            class="absolute right-0 mt-2 w-44 bg-white shadow-lg rounded-lg py-1 z-50">
                            <a href="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">Profile</a>
                            <form action="/logout" method="post">
                                <button type="submit" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">Logout</button>
                            </form>
                        </div>
                    </div>
                <% } else if (locals.user) { %>
                    <div class="relative" x-data="{ open: false }" @click.away="open = false">
                        <button @click="open = !open" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:text-gray-900 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </button>
                        <div x-show="open"
                            x-transition:enter="transition ease-out duration-150"
                            x-transition:enter-start="opacity-0 scale-95"
                            x-transition:enter-end="opacity-100 scale-100"
                            x-transition:leave="transition ease-in duration-100"
                            x-transition:leave-start="opacity-100 scale-100"
                            x-transition:leave-end="opacity-0 scale-95"
                            class="absolute right-0 mt-2 w-44 bg-white shadow-lg rounded-lg py-1 z-50">
                            <a href="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Profile</a>
                            <form action="/logout" method="post">
                                <button type="submit" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Logout</button>
                            </form>
                        </div>
                    </div>
                <% } else { %>
                    <a href="/login" class="text-sm font-medium hover: transition-colors flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        Sign In
                    </a>
                <% } %>
                
                <!-- Mobile Menu Button -->
                <button class="md:hidden text-gray-600 hover:text-gray-900">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </div>
    </header>
    
    <div class="container mx-auto px-4 py-8 flex flex-col lg:flex-row gap-6">
        <!-- Sidebar -->
        <aside class="lg:w-60 bg-white rounded-xl shadow-sm p-4">
            <nav class="space-y-2">
                <a href="/profile"
                    class="flex items-center space-x-3 px-3 py-2.5 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                    <i class="fas fa-user text-sm"></i>
                    <span class="text-sm font-medium">Profile</span>
                </a>
                <a href="/profile/orders" class="flex items-center space-x-3 px-3 py-2.5 bg-black text-white rounded-lg">
                    <i class="fas fa-shopping-cart text-sm"></i>
                    <span class="text-sm font-medium">Orders</span>
                </a>
                <a href="/profile/wishlist"
                    class="flex items-center space-x-3 px-3 py-2.5 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                    <i class="far fa-heart text-sm"></i>
                    <span class="text-sm font-medium">Wishlist</span>
                </a>
                <a href="/profile/address"
                    class="flex items-center space-x-3 px-3 py-2.5 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                    <i class="fas fa-home text-sm"></i>
                    <span class="text-sm font-medium">Address</span>
                </a>
                <a href="/profile/newPassword"
                    class="flex items-center space-x-3 px-3 py-2.5 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                    <i class="fas fa-lock text-sm"></i>
                    <span class="text-sm font-medium">Password</span>
                </a>
                <a href="/profile/wallet"
                    class="flex items-center space-x-3 px-3 py-2.5 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                    <i class="fas fa-wallet text-sm"></i>
                    <span class="text-sm font-medium">Wallet</span>
                </a>
                <a href="/profile/referral"
                    class="flex items-center space-x-3 px-3 py-2.5 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                    <i class="fas fa-users text-sm"></i>
                    <span class="text-sm font-medium">Referral</span>
                </a>
                <a href="#" onclick="document.getElementById('logout-form').submit();"
                    class="flex items-center space-x-3 px-3 py-2.5 text-gray-700 rounded-lg hover:bg-gray-50 transition mt-4">
                    <i class="fas fa-sign-out-alt text-sm"></i>
                    <span class="text-sm font-medium">Logout</span>
                </a>
                <form id="logout-form" action="/logout" method="post" class="hidden"></form>
            </nav>
        </aside>
        
        <!-- Orders Content -->
        <main class="flex-1">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-900">My Orders</h1>
                    <p class="text-gray-500 mt-1">Track and manage your recent purchases</p>
                </div>
            </div>
            
            <!-- Order Search -->
            <div class="mb-6">
                <form method="GET" class="max-w-md">
                    <div class="relative">
                        <input type="text" name="search" placeholder="Search by Order ID (e.g. ABC123...)"
                            class="w-full px-4 py-2 pl-10 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:outline-none"
                            value="<%= typeof currentSearch !== 'undefined' ? currentSearch : '' %>" />
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <% if (locals.currentSearch && currentSearch) { %>
                            <a href="?<%= locals.pagination && locals.pagination.status && locals.pagination.status !== 'all' ? `status=${pagination.status}&` : '' %>page=1"
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </a>
                        <% } %>
                    </div>
                    <% if (locals.currentStatus && currentStatus && currentStatus !== 'all') { %>
                        <input type="hidden" name="status" value="<%= currentStatus %>" />
                    <% } %>
                </form>
            </div>
            
            <!-- Order Filters -->
            <div class="mb-6 border-b border-gray-200">
                <div class="flex space-x-6 pb-2">
                    <a href="?status=all<%= locals.currentSearch ? '&search=' + encodeURIComponent(currentSearch) : '' %>"
                        class="pb-2 border-b-2 <%= (!locals.currentStatus || locals.currentStatus === 'all') ? 'border-black font-medium text-gray-900' : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-800' %>">All Orders</a>
                    <a href="?status=active<%= locals.currentSearch ? '&search=' + encodeURIComponent(currentSearch) : '' %>"
                        class="pb-2 border-b-2 <%= locals.currentStatus === 'active' ? 'border-black font-medium text-gray-900' : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-800' %>">Active</a>
                    <a href="?status=delivered<%= locals.currentSearch ? '&search=' + encodeURIComponent(currentSearch) : '' %>"
                        class="pb-2 border-b-2 <%= locals.currentStatus === 'delivered' ? 'border-black font-medium text-gray-900' : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-800' %>">Completed</a>
                    <a href="?status=cancelled<%= locals.currentSearch ? '&search=' + encodeURIComponent(currentSearch) : '' %>"
                        class="pb-2 border-b-2 <%= locals.currentStatus === 'cancelled' ? 'border-black font-medium text-gray-900' : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-800' %>">Cancelled</a>
                </div>
            </div>
            
            <!-- Dynamic Order List -->
            <div class="space-y-5">
                <% if (locals.orders && orders.length > 0) { %>
                    <% orders.forEach(order => { %>
                        <%
                        let effectiveTotal;
                        const isEntireOrderCancelled = (order.orderStatus || '').toLowerCase() === 'cancelled';
                        if (isEntireOrderCancelled) {
                            // Handle Decimal128 values from MongoDB
                            if (order.totalAmount && typeof order.totalAmount === 'object' && '$numberDecimal' in order.totalAmount) {
                                effectiveTotal = parseFloat(order.totalAmount.$numberDecimal);
                            } else if (typeof order.totalAmount === 'number') {
                                effectiveTotal = order.totalAmount;
                            } else {
                                effectiveTotal = parseFloat(order.totalAmount) || 0;
                            }
                        } else {
                            // Recalculate only for active orders
                            effectiveTotal = 0;
                            if (order.items) {
                                for (let item of order.items.flat()) {
                                    if (item.orderStatus) {
                                        let price = 0;
                                        if (item.price) {
                                            if (item.price.$numberDecimal) price = parseFloat(item.price.$numberDecimal);
                                            else if (typeof item.price === 'string') price = parseFloat(item.price);
                                            else price = parseFloat(item.price) || 0;
                                        }
                                        effectiveTotal += price * (item.quantity || 1);
                                    }
                                }
                            }
                            const orderDiscount = order.discountAmount || 0;
                            effectiveTotal = Math.max(0, effectiveTotal - orderDiscount);
                        }
                        let statusClass = '';
                        const os = (order.orderStatus || '').toLowerCase();
                        if (os === 'delivered') statusClass = 'bg-green-100 text-green-800';
                        else if (os === 'cancelled') statusClass = 'bg-red-100 text-red-800';
                        else if (os === 'shipped') statusClass = 'bg-purple-100 text-purple-800';
                        else if (os === 'returned' || os === 'return requested' || os === 'requestingReturn') statusClass = 'bg-amber-100 text-amber-800';
                        else if (['pending', 'processing', 'active'].includes(os)) statusClass = 'bg-blue-100 text-blue-800';
                        else statusClass = 'bg-gray-100 text-gray-800';
                        %>
                        <div
                            class="bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow cursor-pointer"
                            data-order-id="<%= order._id %>" onclick="showOrderDetails('<%= order._id %>')">
                            <div class="p-5 md:p-6">
                                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                                    <div>
                                        <div class="text-lg font-semibold text-gray-900">Order <%= order.orderId.slice(0, 8) %></div>
                                        <p class="text-gray-500 text-sm mt-1">Placed on <%= new Date(order.createdAt).toLocaleDateString() %></p>
                                    </div>
                                    <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
                                        <div class="text-lg font-bold text-gray-800">₹<%= effectiveTotal.toFixed(2) %></div>
                                        <span class="px-3 py-1 text-xs font-medium rounded-full <%= statusClass %>">
                                            <%= order.orderStatus.charAt(0).toUpperCase() + order.orderStatus.slice(1) %>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div class="bg-white rounded-xl border border-gray-200 p-12 text-center">
                        <div class="text-gray-400 mb-2">
                            <i class="fas fa-box-open text-4xl"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900">No orders found</h3>
                        <p class="text-gray-500 mt-1">Try adjusting your search or filter.</p>
                        <a href="/products"
                            class="mt-4 inline-block px-4 py-2 bg-black text-white text-sm rounded-lg hover:bg-gray-800 transition">Start Shopping</a>
                    </div>
                <% } %>
            </div>
            
            <!-- PAGINATION -->
            <% if (locals.pagination && pagination.totalPages > 1) { %>
                <div class="mt-8 flex items-center justify-between">
                    <div class="text-sm text-gray-500">
                        Showing <%= (pagination.currentPage - 1) * pagination.limit + 1 %> to
                        <%= Math.min(pagination.currentPage * pagination.limit, pagination.totalOrders) %> of
                        <%= pagination.totalOrders %> orders
                    </div>
                    <div class="flex space-x-2">
                        <%
                        const urlParams = new URLSearchParams();
                        if (pagination.status && pagination.status !== 'all') urlParams.set('status', pagination.status);
                        if (pagination.search) urlParams.set('search', pagination.search);
                        %>
                        <% if (pagination.hasPrevPage) { %>
                            <%
                            urlParams.set('page', pagination.currentPage - 1);
                            %>
                            <a href="?<%= urlParams.toString() %>"
                                class="px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        <% } else { %>
                            <span class="px-3 py-2 rounded-lg border border-gray-200 text-gray-400 cursor-not-allowed">
                                <i class="fas fa-chevron-left"></i>
                            </span>
                        <% } %>
                        <% for (let i = Math.max(1, pagination.currentPage - 1); i <= Math.min(pagination.totalPages, pagination.currentPage + 1); i++) { %>
                            <%
                            urlParams.set('page', i);
                            %>
                            <a href="?<%= urlParams.toString() %>" class="px-3 py-2 rounded-lg border
                            <%= i === pagination.currentPage ? 'bg-black text-white border-black' : 'border-gray-300 text-gray-700 hover:bg-gray-50' %>
                            transition">
                                <%= i %>
                            </a>
                        <% } %>
                        <% if (pagination.hasNextPage) { %>
                            <%
                            urlParams.set('page', pagination.currentPage + 1);
                            %>
                            <a href="?<%= urlParams.toString() %>"
                                class="px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        <% } else { %>
                            <span class="px-3 py-2 rounded-lg border border-gray-200 text-gray-400 cursor-not-allowed">
                                <i class="fas fa-chevron-right"></i>
                            </span>
                        <% } %>
                    </div>
                </div>
            <% } %>
        </main>
    </div>
    
    <!-- Hidden order data container -->
    <div id="order-data-container" class="hidden">
        <% if (locals.orders && orders.length > 0) { %>
            <% orders.forEach(order => { %>
                <div id="order-data-<%= order._id %>" class="hidden">
                    <%= JSON.stringify(order) %>
                </div>
            <% }); %>
        <% } %>
    </div>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Main JavaScript -->
    <script>
        // Store order data in memory to avoid JSON parsing issues
        const orderDataCache = {};
        
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('[id^="order-data-"]').forEach(el => {
                const orderId = el.id.replace('order-data-', '');
                try {
                    // Get the inner HTML content (not textContent) to preserve structure
                    let content = el.innerHTML.trim();
                    // Remove HTML entities and extra whitespace
                    content = content
                        .replace(/&quot;/g, '"')
                        .replace(/&amp;/g, '&')
                        .replace(/&lt;/g, '<')
                        .replace(/&gt;/g, '>')
                        .replace(/\\'/g, "'")
                        .replace(/&apos;/g, "'")
                        .replace(/[\u0000-\u001F]/g, '')
                        .replace(/>\s+</g, '><')
                        .replace(/\s+/g, ' ')
                        .trim();

                    // More robust JSON parsing
                    let orderData;
                    try {
                        // Try direct parse first
                        orderData = JSON.parse(content);
                    } catch (directParseError) {
                        // If direct parse fails, try to find and extract valid JSON
                        const firstCurly = content.indexOf('{');
                        if (firstCurly === -1) {
                            throw new Error('No valid JSON object found in content');
                        }

                        // Find the last closing curly brace that matches the first opening one
                        let lastCurly = -1;
                        let braceCount = 0;
                        for (let i = firstCurly; i < content.length; i++) {
                            if (content[i] === '{') braceCount++;
                            if (content[i] === '}') braceCount--;
                            if (braceCount === 0) {
                                lastCurly = i;
                                break;
                            }
                        }

                        // If we couldn't find a matching closing brace, try to find the last one
                        if (lastCurly === -1) {
                            lastCurly = content.lastIndexOf('}');
                        }

                        if (lastCurly === -1 || lastCurly <= firstCurly) {
                            throw new Error('Could not find valid JSON structure');
                        }

                        // Extract the JSON portion
                        let jsonData = content.substring(firstCurly, lastCurly + 1);

                        // Fix common JSON issues
                        jsonData = jsonData
                            // Remove any trailing commas before closing braces/brackets
                            .replace(/,(\s*[}\]])/g, '$1')
                            // Remove any non-printable characters
                            .replace(/[\x00-\x1F\x7F]/g, '')
                            // Ensure proper quoting of keys (basic fix for unquoted keys)
                            .replace(/([{,]\s*)([a-zA-Z0-9_\-]+)\s*:/g, '$1"$2":')
                            .trim();

                        // Try to parse the cleaned JSON
                        orderData = JSON.parse(jsonData);
                    }

                    // Save to cache
                    orderDataCache[orderId] = orderData;
                } catch (error) {
                    console.error('Error parsing order data for ID:', orderId, error);
                    console.error('Problematic content:', content.slice(0, 500));
                    // Create a comprehensive fallback object
                    orderDataCache[orderId] = {
                        _id: orderId,
                        orderId: 'UNKNOWN_' + orderId.substring(0, 8),
                        items: [],
                        orderStatus: 'error',
                        paymentStatus: 'unknown',
                        createdAt: new Date().toISOString(),
                        subTotal: 0,
                        discountAmount: 0,
                        taxAmount: 0,
                        totalAmount: 0,
                        address: {
                            fullName: 'Data not available',
                            streetAddress: 'Address data could not be loaded',
                            city: '',
                            state: '',
                            postalCode: '',
                            country: '',
                            phoneNumber: '',
                            email: ''
                        },
                        error: 'Failed to parse order data'
                    };
                }
            });
        });

        // Common return reasons list
        const returnReasons = [
            { 
                id: 'changed_mind', 
                text: 'Changed my mind / No longer needed', 
                icon: 'fa-brain',
                description: 'You no longer need the item or changed your mind about the purchase'
            },
            { 
                id: 'damaged', 
                text: 'Item damaged or defective', 
                icon: 'fa-exclamation-triangle',
                description: 'The item arrived damaged, broken, or has a manufacturing defect'
            },
            { 
                id: 'wrong_item', 
                text: 'Wrong item received', 
                icon: 'fa-times-circle',
                description: 'You received an item that doesn\'t match what you ordered'
            },
            { 
                id: 'not_as_described', 
                text: 'Item doesn\'t match description', 
                icon: 'fa-info-circle',
                description: 'The item is significantly different from how it was described'
            },
            { 
                id: 'better_price', 
                text: 'Found better price elsewhere', 
                icon: 'fa-tag',
                description: 'You found the exact same item at a lower price from another seller'
            },
            { 
                id: 'delivery_delay', 
                text: 'Delivery was too late', 
                icon: 'fa-clock',
                description: 'The delivery took longer than expected and you no longer need the item'
            },
            { 
                id: 'ordered_by_mistake', 
                text: 'Ordered by mistake', 
                icon: 'fa-mouse-pointer',
                description: 'You accidentally placed the order or ordered duplicate items'
            },
            { 
                id: 'other', 
                text: 'Other reason', 
                icon: 'fa-ellipsis-h',
                description: 'A reason that doesn\'t fit into any of the above categories'
            }
        ];

        // Helper Functions
        function getOrderStatusClass(status) {
            const s = (status || '').toLowerCase();
            if (s === 'delivered') return 'bg-green-100 text-green-800';
            if (s === 'cancelled') return 'bg-red-100 text-red-800';
            if (s === 'shipped') return 'bg-purple-100 text-purple-800';
            if (s === 'returned' || s === 'return requested' || s === 'requestingreturn') return 'bg-amber-100 text-amber-800';
            if (['pending', 'processing', 'active'].includes(s)) return 'bg-blue-100 text-blue-800';
            return 'bg-gray-100 text-gray-800';
        }

        function getPaymentStatusClass(status) {
            const s = (status || '').toLowerCase();
            if (s === 'paid') return 'payment-status-paid';
            if (s === 'pending') return 'payment-status-pending';
            if (s === 'failed') return 'payment-status-failed';
            if (s === 'refunded') return 'bg-yellow-100 text-yellow-800';
            return 'bg-gray-100 text-gray-800';
        }

        function getOrderStatusLabel(status) {
            if (!status) return 'Unknown';
            return status.charAt(0).toUpperCase() + status.slice(1);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        // Show Order Details
        function showOrderDetails(orderId) {
            const order = orderDataCache[orderId];
            if (!order) {
                console.error('Order not found in cache:', orderId);
                Swal.fire('Error', 'Order details not available. Please try again.', 'error');
                return;
            }
            
            const items = Array.isArray(order.items) ? order.items.flat() : [];
            const isEntireOrderCancelled = (order.orderStatus || '').toLowerCase() === 'cancelled';
            const isOrderDelivered = (order.orderStatus || '').toLowerCase() === 'delivered';
            
            let itemsHtml = '';
            
            // Process each item
            items.forEach((item, idx) => {
                const productName = item.productName || 'Unknown Product';
                const color = item.variantColor || '—';
                const quantity = item.quantity || 1;
                let price = 0;
                
                if (item.price) {
                    if (item.price.$numberDecimal) price = parseFloat(item.price.$numberDecimal);
                    else if (typeof item.price === 'string') price = parseFloat(item.price);
                    else price = parseFloat(item.price) || 0;
                }
                
                const isCancelled = item.orderStatus === 'cancelled' || isEntireOrderCancelled;
                const isReturned = item.orderStatus === 'returned' || item.orderStatus === 'return requested' || item.orderStatus === 'requestingReturn';
                const total = (price * quantity).toFixed(2);
                const images = Array.isArray(item.images) ? item.images : [];
                const itemTotal = price * quantity;
                
                // Item actions (cancel or return button if applicable)
                let itemActions = '';
                const os = (order.orderStatus || '').toLowerCase();
                
                if (!isCancelled && !['delivered', 'cancelled', 'returned', 'return requested', 'requestingreturn'].includes(os) && items.length > 1) {
                    itemActions = `
                        <div class="mt-2 flex justify-end">
                            <button
                                onclick="event.stopPropagation(); cancelItem('${order._id}', ${idx});"
                                class="text-xs text-red-600 hover:text-red-800 font-medium flex items-center">
                                <i class="fas fa-times mr-1"></i> Cancel item
                            </button>
                        </div>`;
                } else if (isOrderDelivered && !isCancelled && !isReturned && items.length > 1) {
                    // Add return button for delivered items that haven't been returned yet, ONLY if there are multiple items
                    itemActions = `
                        <div class="mt-2 flex justify-end">
                            <button
                                onclick="event.stopPropagation(); returnItem('${order._id}', ${idx});"
                                class="text-xs text-emerald-600 hover:text-emerald-800 font-medium flex items-center">
                                <i class="fas fa-undo mr-1"></i> Return item
                            </button>
                        </div>`;
                }
                
                // Determine item classes and text styling based on status
                let itemClasses = 'order-item-card hover:shadow-sm';
                if (isCancelled) {
                    itemClasses += ' cancelled-item opacity-70';
                } else if (item.orderStatus === 'return requested' || item.orderStatus === 'requestingReturn') {
                    itemClasses += ' return-requested-item';
                } else if (item.orderStatus === 'returned') {
                    itemClasses += ' returned-item';
                }
                const textClasses = isCancelled ? 'line-through text-gray-500' : 'text-gray-900';
                
                // Status indicator HTML
                let statusHtml = '';
                if (isCancelled) {
                    statusHtml = `<p class="text-sm text-red-600 mt-1"><i class="fas fa-times-circle mr-1"></i> Cancelled</p>`;
                } else if (item.orderStatus === 'return requested' || item.orderStatus === 'requestingReturn') {
                    statusHtml = `<p class="text-sm text-amber-600 mt-1"><i class="fas fa-hourglass-half mr-1"></i> Return Requested <span class="return-requested-badge ml-1">PENDING</span></p>`;
                } else if (item.orderStatus === 'returned') {
                    statusHtml = `<p class="text-sm text-green-600 mt-1"><i class="fas fa-check-circle mr-1"></i> Returned <span class="returned-badge ml-1">APPROVED</span></p>`;
                }
                
                itemsHtml += `
                    <div class="${itemClasses} p-3 mb-2">
                        <div class="flex gap-3">
                            <div class="flex-shrink-0 w-14 h-14 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden border">
                                ${images.length > 0 ? `<img src="${images[0]}" class="w-full h-full object-contain p-1" />` : `<span class="text-gray-400 text-xl">?</span>`}
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-medium ${textClasses} truncate">${productName}</p>
                                <p class="text-sm text-gray-600 mt-0.5">Color: <span class="font-medium">${color}</span></p>
                                <p class="text-sm text-gray-600 mt-0.5">Qty: ${quantity} × ${formatCurrency(price)}</p>
                                ${statusHtml}
                            </div>
                            <div class="text-right flex flex-col items-end justify-between min-w-[100px]">
                                <p class="font-bold ${textClasses}">${formatCurrency(itemTotal)}</p>
                                ${itemActions}
                            </div>
                        </div>
                    </div>`;
            });
            
            // Get backend calculated values - ALL FIELDS FROM DATABASE
            const subtotal = order.subTotal || 0;
            const discount = order.discountAmount || 0;
            const tax = order.taxAmount || 0;
            const shipping = order.shippingAmount || 0;
            const total = order.totalAmount || 0;
            const addr = order.address || {};
            
            // Action buttons logic - Updated to match requirements
            const os = (order.orderStatus || '').toLowerCase();
            const isNonCancellable = ['delivered', 'cancelled', 'returned', 'return requested', 'requestingreturn'].includes(os);
            const isDelivered = os === 'delivered';
            const isReturnRequested = ['return requested', 'requestingreturn'].includes(os);
            
            // Show cancel button only if order is not in non-cancellable status and not already cancelled
            const showCancelEntireButton = !isNonCancellable && !isEntireOrderCancelled;
            
            // Check if any item has an active return request
            const hasAnyReturnRequested = items.some(item =>
                ['requestingreturn', 'return requested', 'returned'].includes((item.orderStatus || '').toLowerCase())
            );
            
            // Show return button only if order is delivered AND no items are in return-related states
            const showReturnButton = isDelivered && !hasAnyReturnRequested && !isReturnRequested;
            
            let actionButtonsHtml = `
                <div class="flex flex-wrap gap-2 mt-6 pt-6 border-t border-gray-200">
                    <button
                        onclick="downloadOrderDetails('${order._id}'); Swal.close();"
                        class="flex-1 sm:flex-none px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                        <i class="fas fa-download"></i> Download Invoice
                    </button>`;
            
            if (showCancelEntireButton) {
                actionButtonsHtml += `
                    <button
                        onclick="confirmCancelOrder('${order._id}', '${order.orderId}')"
                        class="flex-1 sm:flex-none px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition flex items-center justify-center gap-2">
                        <i class="fas fa-ban"></i> Cancel Order
                    </button>`;
            }
            
            if (showReturnButton) {
                actionButtonsHtml += `
                    <button
                        onclick="confirmReturnOrder('${order._id}', '${order.orderId}');"
                        class="flex-1 sm:flex-none px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition flex items-center justify-center gap-2">
                        <i class="fas fa-undo"></i> Request Return
                    </button>`;
            }
            
            actionButtonsHtml += `
                    <button
                        onclick="Swal.close();"
                        class="flex-1 sm:flex-none px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">
                        Close
                    </button>
                </div>`;
            
            const statusClass = getOrderStatusClass(order.orderStatus);
            const statusLabel = getOrderStatusLabel(order.orderStatus);
            
            // Get payment status
            const paymentStatus = order.paymentStatus || 'unknown';
            const paymentStatusClass = getPaymentStatusClass(paymentStatus);
            const paymentStatusLabel = getOrderStatusLabel(paymentStatus);
            
            // Get payment method
            const paymentMethod = order.paymentMethod || 'Payment method not specified';
            
            // Enhanced address display with better UI
            const addressHtml = `
                <div class="address-card">
                    <div class="address-header">
                        <div class="address-title">
                            <div class="address-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <span>Shipping Address</span>
                        </div>
                        <span class="status-badge ${getOrderStatusClass(order.orderStatus)}">${statusLabel}</span>
                    </div>
                    <div class="address-details">
                        <div class="address-item">
                            <div class="address-icon-container">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <div class="address-label">Recipient</div>
                                <div class="address-text">${addr.fullName || 'N/A'}</div>
                            </div>
                        </div>
                        <div class="address-item">
                            <div class="address-icon-container">
                                <i class="fas fa-map-pin"></i>
                            </div>
                            <div>
                                <div class="address-label">Address</div>
                                <div class="address-text">${addr.streetAddress || 'N/A'}<br>${addr.city || 'N/A'}, ${addr.state || 'N/A'} ${addr.postalCode || 'N/A'}</div>
                            </div>
                        </div>
                        <div class="address-item">
                            <div class="address-icon-container">
                                <i class="fas fa-globe"></i>
                            </div>
                            <div>
                                <div class="address-label">Country</div>
                                <div class="address-text">${addr.country || 'N/A'}</div>
                            </div>
                        </div>
                        <div class="address-item">
                            <div class="address-icon-container">
                                <i class="fas fa-phone"></i>
                            </div>
                            <div>
                                <div class="address-label">Primary Contact</div>
                                <div class="contact-badge">
                                    <i class="fas fa-phone-alt"></i>
                                    ${addr.phoneNumber || 'N/A'}
                                </div>
                                ${addr.secondNumber ? `
                                <div class="contact-badge mt-1">
                                    <i class="fas fa-mobile-alt"></i>
                                    ${addr.secondNumber}
                                </div>` : ''}
                            </div>
                        </div>
                        <div class="address-item">
                            <div class="address-icon-container">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div>
                                <div class="address-label">Email</div>
                                <div class="address-text">${addr.email || 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            // ENHANCED ORDER SUMMARY SECTION
            const orderSummaryHtml = `
                <div class="summary-section">
                    <div class="summary-title">
                        <i class="fas fa-calculator text-blue-600"></i>
                        <span>Order Summary</span>
                    </div>
                    <div class="summary-grid">
                        <div class="summary-label">
                            <i class="fas fa-list-ul text-gray-400"></i>
                            Subtotal
                        </div>
                        <div class="summary-value summary-subtotal">${formatCurrency(subtotal)}</div>
                        <div class="summary-label">
                            <i class="fas fa-tag text-red-500"></i>
                            Discount
                        </div>
                        <div class="summary-value summary-discount">-${formatCurrency(discount)}</div>
                        <div class="summary-label">
                            <i class="fas fa-percentage text-purple-600"></i>
                            Tax
                        </div>
                        <div class="summary-value summary-tax">${formatCurrency(tax)}</div>
                        <div class="summary-label">
                            <i class="fas fa-shipping-fast text-sky-600"></i>
                            Shipping
                        </div>
                        <div class="summary-value summary-shipping">${formatCurrency(shipping)}</div>
                    </div>
                    <div class="summary-total">
                        <span>Total Amount</span>
                        <span>${formatCurrency(total)}</span>
                    </div>
                </div>`;
            
            // Build the order details HTML with improved layout
            const orderDetailsHtml = `
                <div class="order-details-container">
                    <div class="mb-4 pb-3 border-b border-gray-200">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3">
                            <div>
                                <h3 class="text-xl font-bold text-gray-900">Order #${order.orderId.slice(0, 8).toUpperCase()}</h3>
                                <p class="text-gray-600 mt-1 text-sm">Placed on ${new Date(order.createdAt).toLocaleDateString('en-US', {
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}</p>
                                <!-- Payment Status Section -->
                                <div class="mt-2 flex items-center space-x-2">
                                    <span class="text-sm font-medium text-gray-500">Payment Method:</span>
                                    <span class="text-sm font-medium text-gray-700">${paymentMethod}</span>
                                </div>
                            </div>
                            <div class="flex flex-col items-end mt-2 sm:mt-0">
                                <span class="status-badge ${statusClass} inline-block mb-1">${statusLabel}</span>
                                <span class="status-badge ${paymentStatusClass} inline-block">Payment: ${paymentStatusLabel}</span>
                            </div>
                        </div>
                    </div>
                    <!-- Items Section -->
                    <div class="mb-5">
                        <h4 class="font-semibold text-gray-900 mb-3 text-lg flex items-center">
                            <i class="fas fa-box-open mr-2 text-gray-500"></i> Items Ordered
                        </h4>
                        ${itemsHtml || '<p class="text-gray-500">No items found in this order.</p>'}
                    </div>
                    <!-- Enhanced Shipping Address Section -->
                    ${addressHtml}
                    <!-- Enhanced Order Summary Section using exact database values -->
                    ${orderSummaryHtml}
                    <!-- Action Buttons -->
                    ${actionButtonsHtml}
                </div>`;
            
            Swal.fire({
                title: null,
                html: orderDetailsHtml,
                showConfirmButton: false,
                customClass: {
                    container: 'order-modal-container',
                    popup: 'rounded-xl shadow-2xl border border-gray-200 max-w-2xl w-full',
                    closeButton: 'text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 rounded-full p-1'
                },
                padding: '1.5rem',
                width: '95%',
            });
        }

        // Cancel Order
        function confirmCancelOrder(orderId, orderNumber) {
            Swal.close();
            Swal.fire({
                title: 'Cancel Entire Order?',
                html: `<p class="text-gray-700">Are you sure you want to cancel order #${orderNumber.slice(0, 8).toUpperCase()}?<br><br>
                <span class="text-red-600 font-medium">Note:</span> A full refund will be processed to your wallet.</p>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, Cancel Order',
                cancelButtonText: 'Keep Order',
                confirmButtonColor: '#ef4444',
                reverseButtons: true,
                customClass: {
                    confirmButton: 'bg-red-600 hover:bg-red-700 text-white',
                    cancelButton: 'bg-gray-200 hover:bg-gray-300 text-gray-800'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Cancelling Order...',
                        html: 'Please wait while we process your request.',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                            fetch(`/profile/orders/${orderId}/cancel`, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' }
                            })
                            .then(res => res.json())
                            .then(data => {
                                Swal.hideLoading();
                                if (data.success) {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Order Cancelled!',
                                        text: 'Your order has been successfully cancelled. A full refund has been processed to your wallet.',
                                        confirmButtonText: 'OK',
                                        customClass: {
                                            confirmButton: 'bg-black hover:bg-gray-800 text-white'
                                        }
                                    }).then(() => location.reload());
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Cancellation Failed',
                                        text: data.message || 'Failed to cancel order. Please try again.',
                                        confirmButtonText: 'OK'
                                    });
                                }
                            })
                            .catch(err => {
                                Swal.hideLoading();
                                console.error('Cancel error:', err);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Network Error',
                                    text: 'Failed to connect to the server. Please check your connection and try again.',
                                    confirmButtonText: 'OK'
                                });
                            });
                        }
                    });
                }
            });
        }

        // Cancel Item
        function cancelItem(orderId, itemIndex) {
            Swal.fire({
                title: 'Cancel This Item?',
                html: '<p class="text-gray-700">Are you sure you want to cancel this item from your order?<br><br><span class="text-red-600 font-medium">Note:</span> The refund will be processed to your wallet.</p>',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, Cancel Item',
                cancelButtonText: 'Keep Item',
                confirmButtonColor: '#ef4444',
                reverseButtons: true,
                customClass: {
                    confirmButton: 'bg-red-600 hover:bg-red-700 text-white',
                    cancelButton: 'bg-gray-200 hover:bg-gray-300 text-gray-800'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Cancelling Item...',
                        html: 'Please wait while we process your request.',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                            fetch(`/profile/orders/${orderId}/items/${itemIndex}/cancel`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' }
                            })
                            .then(res => res.json())
                            .then(data => {
                                Swal.hideLoading();
                                if (data.success) {
                                    // Update item status in cache
                                    if (orderDataCache[orderId] && orderDataCache[orderId].items[itemIndex]) {
                                        orderDataCache[orderId].items[itemIndex].orderStatus = 'cancelled';
                                    }
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Item Cancelled!',
                                        text: 'The item has been successfully cancelled from your order. A refund has been processed to your wallet.',
                                        confirmButtonText: 'OK',
                                        customClass: {
                                            confirmButton: 'bg-black hover:bg-gray-800 text-white'
                                        }
                                    }).then(() => {
                                        // Refresh order details instead of reloading the page
                                        Swal.close();
                                        showOrderDetails(orderId);
                                    });
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Cancellation Failed',
                                        text: data.message || 'Could not cancel item. Please try again.',
                                        confirmButtonText: 'OK'
                                    });
                                }
                            })
                            .catch(err => {
                                Swal.hideLoading();
                                console.error('Error cancelling item:', err);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Network Error',
                                    text: 'Failed to connect to the server. Please check your connection and try again.',
                                    confirmButtonText: 'OK'
                                });
                            });
                        }
                    });
                }
            });
        }

        // Return Item with beautiful dropdown UI
        function returnItem(orderId, itemIndex) {
            // Declare dropdown instance at function scope to fix reference error
            let itemDropdownInstance = null;
            
            Swal.fire({
                title: 'Return This Item?',
                html: `
                <p class="text-gray-700 mb-4">Are you sure you want to return this item?<br><br>
                <span class="text-red-600 font-medium">Note:</span> A refund will be processed to your wallet after approval.</p>
                <div class="mb-4 beautiful-dropdown-container">
                    <label class="dropdown-label">
                        Reason for Return <span class="required">*</span>
                    </label>
                    <div class="beautiful-dropdown">
                        <div class="dropdown-selected empty" id="item-dropdown-selected">
                            <span id="item-dropdown-label" class="dropdown-placeholder">Select a reason for return</span>
                            <i class="fas fa-chevron-down dropdown-icon"></i>
                        </div>
                        <div class="dropdown-menu" id="item-dropdown-menu">
                            <div class="dropdown-search-container" id="item-search-container">
                                <input type="text" class="dropdown-search" id="item-dropdown-search" placeholder="Search reasons...">
                            </div>
                            <div id="item-dropdown-options">
                                <!-- Options will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    <p class="dropdown-instruction">Choose the most appropriate reason for your return</p>
                    <div class="reason-preview" id="item-reason-preview">
                        <div class="reason-preview-title">
                            <i class="fas fa-info-circle"></i> Selected Reason
                        </div>
                        <div id="item-preview-text" class="reason-preview-text">
                            No reason selected yet
                        </div>
                    </div>
                </div>
                <div id="item-other-reason-container" class="mt-3 hidden">
                    <label class="dropdown-label">Additional Details</label>
                    <textarea
                        id="item-other-reason-text"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-y"
                        placeholder="Please provide more details about your reason (minimum 5 characters)"
                        rows="3"
                    ></textarea>
                    <p class="text-xs text-gray-500 mt-1">Help us understand your specific situation to process your return faster</p>
                </div>
                <small class="return-error hidden mt-2" id="return-item-error">
                    <i class="fas fa-exclamation-circle"></i> <span id="return-item-error-text">Please select a reason for return.</span>
                </small>
                `,
                showCancelButton: true,
                confirmButtonText: 'Submit Return Request',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#10b981',
                reverseButtons: true,
                customClass: {
                    confirmButton: 'bg-emerald-600 hover:bg-emerald-700 text-white',
                    cancelButton: 'bg-gray-200 hover:bg-gray-300 text-gray-800',
                    popup: 'rounded-xl border border-gray-200'
                },
                preConfirm: () => {
                    const selectedReason = itemDropdownInstance ? itemDropdownInstance.getSelected() : null;
                    const otherReasonText = document.getElementById('item-other-reason-text');
                    const errorEl = document.getElementById('return-item-error');
                    const errorText = document.getElementById('return-item-error-text');
                    
                    errorEl.classList.add('hidden');
                    
                    if (!selectedReason || !selectedReason.id) {
                        errorText.textContent = 'Please select a reason for return.';
                        errorEl.classList.remove('hidden');
                        document.getElementById('item-dropdown-selected').classList.add('border-red-400');
                        return false;
                    }
                    
                    if (selectedReason.id === 'other' && (!otherReasonText.value || otherReasonText.value.trim().length < 5)) {
                        errorText.textContent = 'Please provide a detailed reason (minimum 5 characters).';
                        errorEl.classList.remove('hidden');
                        otherReasonText.classList.add('border-red-400');
                        return false;
                    }
                    
                    return {
                        reason: selectedReason.id === 'other' ? otherReasonText.value.trim() : selectedReason.text,
                        reasonType: selectedReason.id
                    };
                },
                didOpen: () => {
                    // Initialize the beautiful dropdown
                    const searchContainer = document.getElementById('item-search-container');
                    const searchInput = document.getElementById('item-dropdown-search');
                    const optionsContainer = document.getElementById('item-dropdown-options');
                    const dropdownSelected = document.getElementById('item-dropdown-selected');
                    const dropdownMenu = document.getElementById('item-dropdown-menu');
                    const dropdownLabel = document.getElementById('item-dropdown-label');
                    const reasonPreview = document.getElementById('item-reason-preview');
                    const previewText = document.getElementById('item-preview-text');
                    const otherReasonContainer = document.getElementById('item-other-reason-container');
                    const otherReasonText = document.getElementById('item-other-reason-text');
                    const errorEl = document.getElementById('return-item-error');
                    
                    // Populate dropdown options
                    const renderOptions = (filteredReasons = returnReasons) => {
                        optionsContainer.innerHTML = '';
                        
                        if (filteredReasons.length === 0) {
                            optionsContainer.innerHTML = `<div class="dropdown-no-results">No matching reasons found</div>`;
                            return;
                        }
                        
                        filteredReasons.forEach((reason, index) => {
                            const option = document.createElement('div');
                            option.className = 'dropdown-item';
                            option.style.setProperty('--item-index', index);
                            option.innerHTML = `
                                <i class="fas ${reason.icon}"></i>
                                <div class="dropdown-item-content">
                                    <div class="dropdown-item-title font-medium">${reason.text}</div>
                                    <div class="dropdown-item-description text-xs text-gray-500 mt-0.5">${reason.description}</div>
                                </div>
                            `;
                            option.dataset.id = reason.id;
                            option.dataset.text = reason.text;
                            
                            option.addEventListener('click', () => {
                                dropdownLabel.textContent = reason.text;
                                dropdownLabel.classList.remove('dropdown-placeholder');
                                dropdownSelected.classList.remove('empty');
                                
                                // Update preview
                                previewText.innerHTML = `<strong>${reason.text}:</strong> ${reason.description}`;
                                reasonPreview.classList.add('show');
                                
                                // Close dropdown
                                document.querySelector('.beautiful-dropdown').classList.remove('dropdown-open');
                                
                                // Handle "Other reason" special case
                                if (reason.id === 'other') {
                                    otherReasonContainer.classList.remove('hidden');
                                    setTimeout(() => {
                                        otherReasonText.focus();
                                    }, 100);
                                } else {
                                    otherReasonContainer.classList.add('hidden');
                                }
                                
                                // Clear errors
                                errorEl.classList.add('hidden');
                                dropdownSelected.classList.remove('border-red-400');
                            });
                            
                            optionsContainer.appendChild(option);
                        });
                    };

                    // Initial render
                    renderOptions();
                    
                    // Set up search functionality
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase().trim();
                        
                        if (searchTerm.length > 0) {
                            searchContainer.classList.add('show');
                        } else {
                            searchContainer.classList.remove('show');
                        }
                        
                        const filteredReasons = returnReasons.filter(reason => 
                            reason.text.toLowerCase().includes(searchTerm) || 
                            reason.description.toLowerCase().includes(searchTerm)
                        );
                        
                        renderOptions(filteredReasons);
                    });
                    
                    // Toggle dropdown visibility
                    dropdownSelected.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const dropdown = document.querySelector('.beautiful-dropdown');
                        dropdown.classList.toggle('dropdown-open');
                        
                        if (dropdown.classList.contains('dropdown-open')) {
                            setTimeout(() => {
                                searchInput.focus();
                            }, 100);
                        }
                    });
                    
                    // Close dropdown when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('.beautiful-dropdown')) {
                            document.querySelector('.beautiful-dropdown').classList.remove('dropdown-open');
                        }
                    });
                    
                    // Keyboard navigation
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') {
                            document.querySelector('.beautiful-dropdown').classList.remove('dropdown-open');
                        }
                    });
                    
                    // Focus states
                    dropdownSelected.addEventListener('focus', () => {
                        dropdownSelected.classList.add('focused');
                    });
                    
                    dropdownSelected.addEventListener('blur', () => {
                        dropdownSelected.classList.remove('focused');
                    });
                    
                    // Initialize dropdown instance with API methods
                    itemDropdownInstance = {
                        getSelected: () => {
                            const selectedText = dropdownLabel.textContent;
                            if (selectedText === 'Select a reason for return' || selectedText === '') {
                                return null;
                            }
                            
                            const selectedItem = Array.from(optionsContainer.children).find(item => {
                                return item.querySelector('.dropdown-item-title').textContent === selectedText;
                            });
                            
                            if (selectedItem) {
                                return {
                                    id: selectedItem.dataset.id,
                                    text: selectedItem.dataset.text
                                };
                            }
                            return null;
                        },
                        
                        setSelected: (reasonId) => {
                            const reason = returnReasons.find(r => r.id === reasonId);
                            if (reason) {
                                dropdownLabel.textContent = reason.text;
                                dropdownLabel.classList.remove('dropdown-placeholder');
                                dropdownSelected.classList.remove('empty');
                                
                                // Update preview
                                previewText.innerHTML = `<strong>${reason.text}:</strong> ${reason.description}`;
                                reasonPreview.classList.add('show');
                                
                                if (reason.id === 'other') {
                                    otherReasonContainer.classList.remove('hidden');
                                }
                            }
                        },
                        
                        clearSelection: () => {
                            dropdownLabel.textContent = 'Select a reason for return';
                            dropdownLabel.classList.add('dropdown-placeholder');
                            dropdownSelected.classList.add('empty');
                            reasonPreview.classList.remove('show');
                            otherReasonContainer.classList.add('hidden');
                        }
                    };
                    
                    // Auto-resize textarea when typing
                    if (otherReasonText) {
                        otherReasonText.addEventListener('input', function() {
                            this.style.height = 'auto';
                            this.style.height = (this.scrollHeight) + 'px';
                            errorEl.classList.add('hidden');
                            this.classList.remove('border-red-400');
                        });
                        
                        otherReasonText.addEventListener('focus', () => {
                            errorEl.classList.add('hidden');
                            otherReasonText.classList.remove('border-red-400');
                        });
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const reasonData = result.value;
                    Swal.fire({
                        title: 'Processing Request...',
                        html: 'Please wait while we submit your return request.',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                            fetch(`/profile/orders/${orderId}/items/${itemIndex}/return`, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ reason: reasonData.reason, reasonType: reasonData.reasonType })
                            })
                            .then(res => res.json())
                            .then(data => {
                                Swal.hideLoading();
                                if (data.success) {
                                    // Update the item status in the local cache
                                    if (orderDataCache[orderId] && orderDataCache[orderId].items[itemIndex]) {
                                        orderDataCache[orderId].items[itemIndex].orderStatus = 'requestingReturn';
                                        orderDataCache[orderId].items[itemIndex].returnReason = reasonData.reason;
                                        orderDataCache[orderId].items[itemIndex].returnReasonType = reasonData.reasonType;
                                        orderDataCache[orderId].items[itemIndex].returnRequestedAt = new Date().toISOString();
                                    }
                                    
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Return Request Submitted!',
                                        html: "We've received your return request for this item. Our customer support team will contact you shortly with further instructions and return shipping details.",
                                        confirmButtonText: 'OK',
                                        customClass: {
                                            confirmButton: 'bg-black hover:bg-gray-800 text-white'
                                        }
                                    }).then(() => {
                                        Swal.close();
                                        showOrderDetails(orderId);
                                    });
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Request Failed',
                                        text: data.message || 'Failed to submit return request. Please try again.',
                                        confirmButtonText: 'OK'
                                    });
                                }
                            })
                            .catch(err => {
                                Swal.hideLoading();
                                console.error('Return error:', err);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Network Error',
                                    text: 'Failed to connect to the server. Please check your connection and try again.',
                                    confirmButtonText: 'OK'
                                });
                            });
                        }
                    });
                }
            });
        }

        // Confirm Return Order with beautiful dropdown UI
        function confirmReturnOrder(orderId, orderNumber) {
            // Declare dropdown instance at function scope to fix reference error
            let dropdownInstance = null;
            
            Swal.fire({
                title: 'Request a Return?',
                html: `
                <p class="text-gray-700 mb-4">Order #${orderNumber.slice(0, 8).toUpperCase()}</p>
                <div class="mb-4 beautiful-dropdown-container">
                    <label class="dropdown-label">
                        Reason for Return <span class="required">*</span>
                    </label>
                    <div class="beautiful-dropdown">
                        <div class="dropdown-selected empty" id="dropdown-selected">
                            <span id="dropdown-label" class="dropdown-placeholder">Select a reason for return</span>
                            <i class="fas fa-chevron-down dropdown-icon"></i>
                        </div>
                        <div class="dropdown-menu" id="dropdown-menu">
                            <div class="dropdown-search-container" id="search-container">
                                <input type="text" class="dropdown-search" id="dropdown-search" placeholder="Search reasons...">
                            </div>
                            <div id="dropdown-options">
                                <!-- Options will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    <p class="dropdown-instruction">Choose the most appropriate reason for your return</p>
                    <div class="reason-preview" id="reason-preview">
                        <div class="reason-preview-title">
                            <i class="fas fa-info-circle"></i> Selected Reason
                        </div>
                        <div id="preview-text" class="reason-preview-text">
                            No reason selected yet
                        </div>
                    </div>
                </div>
                <div id="other-reason-container" class="mt-3 hidden">
                    <label class="dropdown-label">Additional Details</label>
                    <textarea
                        id="other-reason-text"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-y"
                        placeholder="Please provide more details about your reason (minimum 5 characters)"
                        rows="3"
                    ></textarea>
                    <p class="text-xs text-gray-500 mt-1">Help us understand your specific situation to process your return faster</p>
                </div>
                <small class="return-error hidden mt-2" id="return-error">
                    <i class="fas fa-exclamation-circle"></i> <span id="return-error-text">Please select a reason for return.</span>
                </small>
                `,
                showCancelButton: true,
                confirmButtonText: 'Submit Return Request',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#10b981',
                reverseButtons: true,
                customClass: {
                    confirmButton: 'bg-emerald-600 hover:bg-emerald-700 text-white',
                    cancelButton: 'bg-gray-200 hover:bg-gray-300 text-gray-800',
                    popup: 'rounded-xl border border-gray-200'
                },
                preConfirm: () => {
                    const selectedReason = dropdownInstance ? dropdownInstance.getSelected() : null;
                    const otherReasonText = document.getElementById('other-reason-text');
                    const errorEl = document.getElementById('return-error');
                    const errorText = document.getElementById('return-error-text');
                    
                    errorEl.classList.add('hidden');
                    
                    if (!selectedReason || !selectedReason.id) {
                        errorText.textContent = 'Please select a reason for return.';
                        errorEl.classList.remove('hidden');
                        document.getElementById('dropdown-selected').classList.add('border-red-400');
                        return false;
                    }
                    
                    if (selectedReason.id === 'other' && (!otherReasonText.value || otherReasonText.value.trim().length < 5)) {
                        errorText.textContent = 'Please provide a detailed reason (minimum 5 characters).';
                        errorEl.classList.remove('hidden');
                        otherReasonText.classList.add('border-red-400');
                        return false;
                    }
                    
                    return {
                        reason: selectedReason.id === 'other' ? otherReasonText.value.trim() : selectedReason.text,
                        reasonType: selectedReason.id
                    };
                },
                didOpen: () => {
                    // Initialize the beautiful dropdown
                    const searchContainer = document.getElementById('search-container');
                    const searchInput = document.getElementById('dropdown-search');
                    const optionsContainer = document.getElementById('dropdown-options');
                    const dropdownSelected = document.getElementById('dropdown-selected');
                    const dropdownMenu = document.getElementById('dropdown-menu');
                    const dropdownLabel = document.getElementById('dropdown-label');
                    const reasonPreview = document.getElementById('reason-preview');
                    const previewText = document.getElementById('preview-text');
                    const otherReasonContainer = document.getElementById('other-reason-container');
                    const otherReasonText = document.getElementById('other-reason-text');
                    const errorEl = document.getElementById('return-error');
                    
                    // Populate dropdown options
                    const renderOptions = (filteredReasons = returnReasons) => {
                        optionsContainer.innerHTML = '';
                        
                        if (filteredReasons.length === 0) {
                            optionsContainer.innerHTML = `<div class="dropdown-no-results">No matching reasons found</div>`;
                            return;
                        }
                        
                        filteredReasons.forEach((reason, index) => {
                            const option = document.createElement('div');
                            option.className = 'dropdown-item';
                            option.style.setProperty('--item-index', index);
                            option.innerHTML = `
                                <i class="fas ${reason.icon}"></i>
                                <div class="dropdown-item-content">
                                    <div class="dropdown-item-title font-medium">${reason.text}</div>
                                    <div class="dropdown-item-description text-xs text-gray-500 mt-0.5">${reason.description}</div>
                                </div>
                            `;
                            option.dataset.id = reason.id;
                            option.dataset.text = reason.text;
                            
                            option.addEventListener('click', () => {
                                dropdownLabel.textContent = reason.text;
                                dropdownLabel.classList.remove('dropdown-placeholder');
                                dropdownSelected.classList.remove('empty');
                                
                                // Update preview
                                previewText.innerHTML = `<strong>${reason.text}:</strong> ${reason.description}`;
                                reasonPreview.classList.add('show');
                                
                                // Close dropdown
                                document.querySelector('.beautiful-dropdown').classList.remove('dropdown-open');
                                
                                // Handle "Other reason" special case
                                if (reason.id === 'other') {
                                    otherReasonContainer.classList.remove('hidden');
                                    setTimeout(() => {
                                        otherReasonText.focus();
                                    }, 100);
                                } else {
                                    otherReasonContainer.classList.add('hidden');
                                }
                                
                                // Clear errors
                                errorEl.classList.add('hidden');
                                dropdownSelected.classList.remove('border-red-400');
                            });
                            
                            optionsContainer.appendChild(option);
                        });
                    };

                    // Initial render
                    renderOptions();
                    
                    // Set up search functionality
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase().trim();
                        
                        if (searchTerm.length > 0) {
                            searchContainer.classList.add('show');
                        } else {
                            searchContainer.classList.remove('show');
                        }
                        
                        const filteredReasons = returnReasons.filter(reason => 
                            reason.text.toLowerCase().includes(searchTerm) || 
                            reason.description.toLowerCase().includes(searchTerm)
                        );
                        
                        renderOptions(filteredReasons);
                    });
                    
                    // Toggle dropdown visibility
                    dropdownSelected.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const dropdown = document.querySelector('.beautiful-dropdown');
                        dropdown.classList.toggle('dropdown-open');
                        
                        if (dropdown.classList.contains('dropdown-open')) {
                            setTimeout(() => {
                                searchInput.focus();
                            }, 100);
                        }
                    });
                    
                    // Close dropdown when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('.beautiful-dropdown')) {
                            document.querySelector('.beautiful-dropdown').classList.remove('dropdown-open');
                        }
                    });
                    
                    // Keyboard navigation
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') {
                            document.querySelector('.beautiful-dropdown').classList.remove('dropdown-open');
                        }
                    });
                    
                    // Focus states
                    dropdownSelected.addEventListener('focus', () => {
                        dropdownSelected.classList.add('focused');
                    });
                    
                    dropdownSelected.addEventListener('blur', () => {
                        dropdownSelected.classList.remove('focused');
                    });
                    
                    // Initialize dropdown instance with API methods
                    dropdownInstance = {
                        getSelected: () => {
                            const selectedText = dropdownLabel.textContent;
                            if (selectedText === 'Select a reason for return' || selectedText === '') {
                                return null;
                            }
                            
                            const selectedItem = Array.from(optionsContainer.children).find(item => {
                                return item.querySelector('.dropdown-item-title').textContent === selectedText;
                            });
                            
                            if (selectedItem) {
                                return {
                                    id: selectedItem.dataset.id,
                                    text: selectedItem.dataset.text
                                };
                            }
                            return null;
                        },
                        
                        setSelected: (reasonId) => {
                            const reason = returnReasons.find(r => r.id === reasonId);
                            if (reason) {
                                dropdownLabel.textContent = reason.text;
                                dropdownLabel.classList.remove('dropdown-placeholder');
                                dropdownSelected.classList.remove('empty');
                                
                                // Update preview
                                previewText.innerHTML = `<strong>${reason.text}:</strong> ${reason.description}`;
                                reasonPreview.classList.add('show');
                                
                                if (reason.id === 'other') {
                                    otherReasonContainer.classList.remove('hidden');
                                }
                            }
                        },
                        
                        clearSelection: () => {
                            dropdownLabel.textContent = 'Select a reason for return';
                            dropdownLabel.classList.add('dropdown-placeholder');
                            dropdownSelected.classList.add('empty');
                            reasonPreview.classList.remove('show');
                            otherReasonContainer.classList.add('hidden');
                        }
                    };
                    
                    // Auto-resize textarea when typing
                    if (otherReasonText) {
                        otherReasonText.addEventListener('input', function() {
                            this.style.height = 'auto';
                            this.style.height = (this.scrollHeight) + 'px';
                            errorEl.classList.add('hidden');
                            this.classList.remove('border-red-400');
                        });
                        
                        otherReasonText.addEventListener('focus', () => {
                            errorEl.classList.add('hidden');
                            otherReasonText.classList.remove('border-red-400');
                        });
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const reasonData = result.value;
                    Swal.fire({
                        title: 'Processing Request...',
                        html: 'Please wait while we submit your return request.',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                            fetch(`/profile/orders/${orderId}/return`, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ reason: reasonData.reason, reasonType: reasonData.reasonType })
                            })
                            .then(res => res.json())
                            .then(data => {
                                Swal.hideLoading();
                                if (data.success) {
                                    // Update order status in cache if available
                                    if (orderDataCache[orderId]) {
                                        orderDataCache[orderId].orderStatus = 'requestingReturn';
                                        orderDataCache[orderId].returnReason = reasonData.reason;
                                        orderDataCache[orderId].returnReasonType = reasonData.reasonType;
                                        orderDataCache[orderId].returnRequestedAt = new Date().toISOString();
                                    }
                                    
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Return Request Submitted!',
                                        html: "We've received your return request. Our customer support team will contact you shortly with further instructions and return shipping details.",
                                        confirmButtonText: 'OK',
                                        customClass: {
                                            confirmButton: 'bg-black hover:bg-gray-800 text-white'
                                        }
                                    }).then(() => {
                                        // Refresh order details instead of reloading the page
                                        Swal.close();
                                        showOrderDetails(orderId);
                                    });
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Request Failed',
                                        text: data.message || 'Failed to submit return request. Please try again.',
                                        confirmButtonText: 'OK'
                                    });
                                }
                            })
                            .catch(err => {
                                Swal.hideLoading();
                                console.error('Return error:', err);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Network Error',
                                    text: 'Failed to connect to the server. Please check your connection and try again.',
                                    confirmButtonText: 'OK'
                                });
                            });
                        }
                    });
                }
            });
        }

        // Download Order Details
        function downloadOrderDetails(orderId) {
            // Try to get order from cache first
            let order = orderDataCache[orderId];
            if (!order) {
                console.error('Order not found in cache:', orderId);
                Swal.fire('Error', 'Order details not available. Please refresh the page and try again.', 'error');
                return;
            }
            generateInvoice(order);
        }

        // Generate Invoice
        function generateInvoice(order) {
            const items = Array.isArray(order.items) ? order.items.flat() : [];
            const addr = order.address || {};
            const orderDate = new Date(order.createdAt);
            const invoiceDate = new Date();
            
            // Get backend calculated values - ALL FIELDS FROM DATABASE
            const subtotal = order.subTotal || 0;
            const discount = order.discountAmount || 0;
            const tax = order.taxAmount || 0;
            const shipping = order.shippingAmount || 0;
            const total = order.totalAmount || 0;
            const os = (order.orderStatus || '').toLowerCase();
            const paymentStatus = order.paymentStatus || 'unknown';
            const paymentMethod = order.paymentMethod || 'Payment method not specified';
            
            // Format currency values
            const formatInvoiceCurrency = (amount) => {
                return '₹' + parseFloat(amount).toFixed(2);
            };
            
            // Generate items table rows with enhanced cancelled item highlighting
            const itemsHtml = items.map(item => {
                const productName = item.productName || 'Unknown Product';
                const color = item.variantColor || '—';
                const quantity = item.quantity || 1;
                let price = 0;
                
                if (item.price) {
                    if (item.price.$numberDecimal) price = parseFloat(item.price.$numberDecimal);
                    else if (typeof item.price === 'string') price = parseFloat(item.price);
                    else price = parseFloat(item.price) || 0;
                }
                
                const total = (price * quantity).toFixed(2);
                const isCancelled = item.orderStatus === 'cancelled';
                const isReturned = item.orderStatus === 'returned' || item.orderStatus === 'return requested' || item.orderStatus === 'requestingReturn';
                
                // Set classes based on status
                let rowClass = '';
                let nameClass = '';
                let priceClass = '';
                let statusBadge = '';
                
                if (isCancelled) {
                    rowClass = 'bg-red-50/70 border-l-4 border-red-500';
                    nameClass = 'line-through text-gray-500';
                    priceClass = 'text-red-600 font-medium line-through';
                    statusBadge = '<span class="cancelled-badge ml-2">CANCELLED</span>';
                } else if (isReturned) {
                    rowClass = 'bg-amber-50/70 border-l-4 border-amber-500';
                    nameClass = 'line-through text-gray-500';
                    priceClass = 'text-amber-600 font-medium line-through';
                    statusBadge = `<span class="${item.orderStatus === 'returned' ? 'returned-badge' : 'requesting-return-badge'} ml-2">${item.orderStatus === 'returned' ? 'RETURNED' : 'RETURN REQUESTED'}</span>`;
                } else {
                    rowClass = '';
                    nameClass = 'font-medium text-gray-900';
                    priceClass = 'font-medium text-gray-900';
                    statusBadge = '';
                }
                
                return `
                    <tr class="${rowClass}">
                        <td class="p-3 border-b border-gray-200">
                            <div class="${nameClass} flex items-start justify-between">
                                <span>${productName}</span>
                                ${statusBadge}
                            </div>
                            <div class="text-sm text-gray-600 mt-1">Color: ${color}</div>
                            ${isCancelled || isReturned ? `
                            <div class="text-xs ${isCancelled ? 'text-red-600' : 'text-amber-600'} mt-1 font-medium">
                                ${isCancelled ? 'This item was cancelled' : 'This item was returned'}
                            </div>
                            ` : ''}
                        </td>
                        <td class="p-3 border-b border-gray-200 text-center">${quantity}</td>
                        <td class="p-3 border-b border-gray-200 text-right ${priceClass}">${formatInvoiceCurrency(price)}</td>
                        <td class="p-3 border-b border-gray-200 text-right ${priceClass}">${formatInvoiceCurrency(total)}</td>
                    </tr>
                `;
            }).join('');
            
            // ENHANCED INVOICE SUMMARY SECTION
            const invoiceSummaryHtml = `
                <div class="summary-section mt-6">
                    <div class="summary-title">
                        <i class="fas fa-calculator text-blue-600"></i>
                        <span>Order Summary</span>
                    </div>
                    <div class="summary-grid">
                        <div class="summary-label">
                            <i class="fas fa-list-ul text-gray-400"></i>
                            Subtotal
                        </div>
                        <div class="summary-value summary-subtotal">${formatInvoiceCurrency(subtotal)}</div>
                        <div class="summary-label">
                            <i class="fas fa-tag text-red-500"></i>
                            Discount
                        </div>
                        <div class="summary-value summary-discount">-${formatInvoiceCurrency(discount)}</div>
                        <div class="summary-label">
                            <i class="fas fa-percentage text-purple-600"></i>
                            Tax
                        </div>
                        <div class="summary-value summary-tax">${formatInvoiceCurrency(tax)}</div>
                        <div class="summary-label">
                            <i class="fas fa-shipping-fast text-sky-600"></i>
                            Shipping
                        </div>
                        <div class="summary-value summary-shipping">${formatInvoiceCurrency(shipping)}</div>
                    </div>
                    <div class="summary-total">
                        <span>Total Amount</span>
                        <span>${formatInvoiceCurrency(total)}</span>
                    </div>
                </div>`;
            
            // Generate printable content
            const printableContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Order Invoice - ${order.orderId}</title>
                    <style>
                        .invoice-container {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            line-height: 1.5;
                            color: #333;
                            max-width: 800px;
                            margin: 0 auto;
                            padding: 20px;
                        }
                        .invoice-header {
                            text-align: center;
                            border-bottom: 2px solid #333;
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                        }
                        .invoice-logo {
                            font-size: 28px;
                            font-weight: 800;
                            color: #000;
                            letter-spacing: -0.5px;
                        }
                        .invoice-details {
                            display: flex;
                            justify-content: space-between;
                            margin: 20px 0;
                        }
                        .invoice-number {
                            font-size: 18px;
                            font-weight: 600;
                            color: #333;
                        }
                        .invoice-date {
                            color: #666;
                        }
                        .status-badge {
                            display: inline-block;
                            padding: 4px 10px;
                            border-radius: 20px;
                            font-size: 13px;
                            font-weight: 500;
                            text-transform: capitalize;
                            margin-top: 5px;
                        }
                        .status-delivered { background-color: #dcfce7; color: #15803d; }
                        .status-pending,
                        .status-processing,
                        .status-active { background-color: #dbeafe; color: #1d4ed8; }
                        .status-shipped { background-color: #ede9fe; color: #6d28d9; }
                        .status-cancelled { background-color: #fee2e2; color: #b91c1c; }
                        .status-returned,
                        .status-return-requested,
                        .status-requestingReturn { background-color: #fef3c7; color: #b45309; }
                        .payment-status-paid { background-color: #dcfce7; color: #15803d; }
                        .payment-status-pending { background-color: #fef3c7; color: #b45309; }
                        .payment-status-failed { background-color: #fee2e2; color: #b91c1c; }
                        .section {
                            margin-bottom: 25px;
                        }
                        .section-title {
                            font-size: 18px;
                            font-weight: 600;
                            margin-bottom: 12px;
                            color: #333;
                            padding-bottom: 6px;
                            border-bottom: 1px solid #eee;
                        }
                        .invoice-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 15px 0;
                        }
                        .invoice-table th {
                            background-color: #f8fafc;
                            font-weight: 600;
                            color: #4b5563;
                            text-align: left;
                            padding: 10px;
                            border-bottom: 2px solid #e2e8f0;
                        }
                        .invoice-table td {
                            padding: 10px;
                            border-bottom: 1px solid #e2e8f0;
                        }
                        .invoice-table .item-name {
                            font-weight: 500;
                        }
                        .summary {
                            margin-top: 20px;
                            background-color: #f9fafb;
                            border-radius: 8px;
                            padding: 15px;
                        }
                        .summary-row {
                            display: flex;
                            justify-content: space-between;
                            padding: 8px 0;
                            border-bottom: 1px dashed #e2e8f0;
                        }
                        .summary-row:last-child {
                            border-bottom: none;
                        }
                        .summary-label {
                            font-weight: 500;
                            color: #4b5563;
                        }
                        .summary-value {
                            font-weight: 500;
                        }
                        .summary-total {
                            font-weight: 700;
                            font-size: 18px;
                            color: #000;
                            padding-top: 10px;
                            border-top: 2px solid #000;
                        }
                        .footer {
                            margin-top: 40px;
                            text-align: center;
                            color: #666;
                            font-size: 14px;
                            border-top: 1px solid #eee;
                            padding-top: 20px;
                        }
                        .no-print {
                            text-align: center;
                            margin-top: 30px;
                            padding: 15px;
                            background: #f0f9ff;
                            border-radius: 8px;
                            border: 1px dashed #bae6fd;
                        }
                        .print-button {
                            background: #3b82f6;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-weight: 500;
                            display: inline-flex;
                            align-items: center;
                            gap: 8px;
                            transition: all 0.2s ease;
                        }
                        .print-button:hover {
                            background: #2563eb;
                            transform: translateY(-1px);
                            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
                        }
                        .print-button:active {
                            transform: translateY(0);
                        }
                        @media print {
                            .no-print { display: none; }
                            body { -webkit-print-color-adjust: exact; }
                        }
                    </style>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                </head>
                <body>
                    <div class="invoice-container" id="printable-order">
                        <div class="invoice-header">
                            <div class="invoice-logo">CASEN</div>
                            <div class="invoice-details">
                                <div>
                                    <div class="invoice-number">Order #${order.orderId.slice(0, 8).toUpperCase()}</div>
                                    <div class="invoice-date">Order Date: ${orderDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                                </div>
                                <div class="text-right">
                                    <span class="status-badge status-${os.replace(' ', '-')} mb-1">${getOrderStatusLabel(order.orderStatus)}</span><br>
                                    <span class="status-badge ${getPaymentStatusClass(paymentStatus)}">Payment: ${getOrderStatusLabel(paymentStatus)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="section">
                            <div class="section-title">Customer Information</div>
                            <div>
                                ${addr.fullName || 'N/A'}<br>
                                ${addr.streetAddress || 'N/A'}<br>
                                ${addr.city || ''} ${addr.state || ''} ${addr.postalCode || ''}<br>
                                ${addr.country || 'N/A'}<br>
                                Phone: ${addr.phoneNumber || 'N/A'}<br>
                                ${addr.secondNumber ? `Alternate: ${addr.secondNumber}<br>` : ''}
                            </div>
                        </div>
                        <div class="section">
                            <div class="section-title">Order Details</div>
                            <div>
                                <strong>Payment Method:</strong> ${paymentMethod}<br>
                                <strong>Payment Status:</strong> ${getOrderStatusLabel(paymentStatus)}
                            </div>
                        </div>
                        <div class="section">
                            <div class="section-title">Items Ordered</div>
                            <table class="invoice-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50%;">Product</th>
                                        <th style="width: 15%;">Qty</th>
                                        <th style="width: 15%;">Unit Price</th>
                                        <th style="width: 20%;">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsHtml}
                                </tbody>
                            </table>
                        </div>
                        <!-- Enhanced Invoice Summary Section -->
                        ${invoiceSummaryHtml}
                        <div class="footer">
                            <p>Thank you for your order! This invoice was generated on ${invoiceDate.toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}</p>
                            <p>This is an automatically generated invoice. No signature required.</p>
                            <p>Contact us: support@casen.com | +91 XXXXXXXXXX</p>
                        </div>
                        <div class="no-print">
                            <p><strong>Tip:</strong> Use Ctrl+P (or Cmd+P on Mac) to save as PDF or print this invoice.</p>
                            <button class="print-button" onclick="window.print()">
                                <i class="fas fa-print"></i> Print or Save as PDF
                            </button>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank', 'width=900,height=700');
            if (!printWindow) {
                Swal.fire('Warning', 'Popup blocked. Please allow popups to view the invoice.', 'warning');
                return;
            }
            
            printWindow.document.write(printableContent);
            printWindow.document.close();
            
            // Focus the window after a delay to ensure it's fully loaded
            setTimeout(() => {
                printWindow.focus();
            }, 500);
        }
    </script>
</body>
</html>