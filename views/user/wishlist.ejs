<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Wishlist</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>
<body class="bg-gray-50">

  <!-- Header (Exactly as provided) -->
<header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <!-- Logo -->
            <div class="flex items-center">
                <a href="/">
                    <img src="/logo.png" alt="Logo" class="h-8 object-contain">
                </a>
            </div>

            <!-- Desktop Navigation -->
            <nav class="hidden md:flex space-x-5">
                <a href="/" class="text-sm font-medium transition-opacity hover:opacity-80">Home</a>
                <a href="/about" class="text-sm font-medium transition-opacity hover:opacity-80">About</a>
                <a href="/products" class="text-sm font-medium transition-opacity hover:opacity-80">Phone Cases</a>
                <a href="#" class="text-sm font-medium transition-opacity hover:opacity-80">Tablet Cases</a>
                <a href="/products" class="text-sm font-medium transition-opacity hover:opacity-80">Sale</a>
            </nav>

            <!-- Icons & Auth -->
            <div class="flex items-center space-x-4">
                <!-- Wishlist -->
                <button class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" onclick="window.location.href='/profile/wishlist'">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                    </svg>
                </button>

                <!-- Cart -->
                <button class="p-2 rounded-full hover:bg-gray-100 transition-colors relative" onclick="window.location.href='/cart'">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                </button>

                <!-- User Menu -->
                <% if (locals.user && user.profilePic) { %>
                <div class="relative" x-data="{ open: false, imageError: false }" @click.away="open = false">
                    <button @click="open = !open" class="rounded-full overflow-hidden w-8 h-8 border border-transparent hover:border-gray-300 transition-colors focus:outline-none">
                        <template x-if="!imageError">
                            <img src="<%= user.profilePic %>" @error="imageError = true" alt="Profile" class="w-full h-full object-cover" />
                        </template>
                        <template x-if="imageError">
                            <div class="w-full h-full bg-gray-300 flex items-center justify-center text-gray-600 rounded-full">
                                <span class="font-medium text-sm"><%= user.name ? user.name.charAt(0).toUpperCase() : 'U' %></span>
                            </div>
                        </template>
                    </button>
                    <div x-show="open"
                         x-transition:enter="transition ease-out duration-150"
                         x-transition:enter-start="opacity-0 scale-95"
                         x-transition:enter-end="opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-100"
                         x-transition:leave-start="opacity-100 scale-100"
                         x-transition:leave-end="opacity-0 scale-95"
                         class="absolute right-0 mt-2 w-44 bg-white shadow-lg rounded-lg py-1 z-50">
                        <a href="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">Profile</a>
                        <form action="/logout" method="post">
                            <button type="submit" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">Logout</button>
                        </form>
                    </div>
                </div>
                <% } else if (locals.user) { %>
                <div class="relative" x-data="{ open: false }" @click.away="open = false">
                    <button @click="open = !open" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:text-gray-900 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </button>
                    <div x-show="open"
                         x-transition:enter="transition ease-out duration-150"
                         x-transition:enter-start="opacity-0 scale-95"
                         x-transition:enter-end="opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-100"
                         x-transition:leave-start="opacity-100 scale-100"
                         x-transition:leave-end="opacity-0 scale-95"
                         class="absolute right-0 mt-2 w-44 bg-white shadow-lg rounded-lg py-1 z-50">
                        <a href="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Profile</a>
                        <form action="/logout" method="post">
                            <button type="submit" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Logout</button>
                        </form>
                    </div>
                </div>
                <% } else { %>
                <a href="/login" class="text-sm font-medium hover: transition-colors flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    Sign In
                </a>
                <% } %>

                <!-- Mobile Menu Button -->
                <button class="md:hidden text-gray-600 hover:text-gray-900">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

  <!-- Main Content -->
  <div class="container mx-auto px-4 py-8 flex flex-col lg:flex-row gap-6">

    <!-- Sidebar (Exactly as provided) -->
    <aside class="lg:w-60 bg-white rounded-xl shadow-sm overflow-hidden">
      <nav class="p-4 space-y-1">
        <a href="/profile" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
          <i class="fas fa-user text-sm"></i>
          <span class="font-medium text-sm">Profile</span>
        </a>
        <a href="/profile/orders" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
          <i class="fas fa-shopping-cart text-sm"></i>
          <span class="font-medium text-sm">Orders</span>
        </a>
        <a href="/profile/wishlist" class="flex items-center space-x-3 px-4 py-3 bg-black text-white rounded-lg transition-colors">
          <i class="far fa-heart text-sm"></i>
          <span class="font-medium text-sm">Wishlist</span>
        </a>
        <a href="/profile/address" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
          <i class="fas fa-home text-sm"></i>
          <span class="font-medium text-sm">Address</span>
        </a>
        <a href="/profile/newPassword" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
          <i class="fas fa-lock text-sm"></i>
          <span class="font-medium text-sm">Password</span>
        </a>
        <a href="/profile/wallet" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
          <i class="fas fa-wallet text-sm"></i>
          <span class="font-medium text-sm">Wallet</span>
        </a>
        <a href="/profile/referral" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
          <i class="fas fa-users text-sm"></i>
          <span class="font-medium text-sm">Referral</span>
        </a>
        <a href="#" onclick="document.getElementById('logout-form').submit();" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors mt-4">
          <i class="fas fa-sign-out-alt text-sm"></i>
          <span class="font-medium text-sm">Logout</span>
        </a>
        <form id="logout-form" action="/logout" method="post" class="hidden"></form>
      </nav>
    </aside>

    <!-- Wishlist Content -->
    <main class="flex-1">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">My Wishlist</h1>
          <p class="text-gray-500 mt-1"><%= (wishlistItems && wishlistItems.length) ? wishlistItems.length : 0 %> items</p>
        </div>
      </div>

      <!-- Wishlist Items -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <% if (wishlistItems && wishlistItems.length > 0) { %>
          <% wishlistItems.forEach(item => { %>
            <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
              <div class="flex justify-center mb-4">
                <img src="<%= (item.variant && item.variant.images && item.variant.images[0]) ? item.variant.images[0] : '/placeholder.jpg' %>" 
                     alt="<%= item.product?.productName || 'Product' %>" 
                     class="w-full h-64 object-contain rounded-lg">
              </div>
              <h3 class="text-xl font-semibold text-gray-900 mb-1"><%= item.product?.productName || 'Unknown Product' %></h3>
              <p class="text-gray-700 font-bold mb-4">â‚¹<%= item.variant?.price || '0' %></p>
              <div class="flex justify-between">
                <button class="bg-black text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition-colors w-full mr-2"
                        onclick="addToCart('<%= item.productId %>', '<%= item.variantId %>')">
                  Add to Cart
                </button>
                <button class="text-gray-500 hover:text-red-600"
                        onclick="confirmDeleteWishlistItem('<%= item._id %>')">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A1 1 0 0117.133 20H6.867A1 1 0 016 19.133L5.133 7M20 7V5a2 2 0 00-2-2h-2.343M15 7v5m-5-5v5m-5-5v5m-2 2h16v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2z" />
                  </svg>
                </button>
              </div>
            </div>
          <% }); %>
        <% } else { %>
          <div class="col-span-full text-center py-12">
            <p class="text-gray-500 text-lg">Your wishlist is empty.</p>
          </div>
        <% } %>
      </div>

      <!-- Pagination -->
      <% if (typeof totalPages !== 'undefined' && totalPages > 1) { %>
        <div class="flex justify-center mt-8 space-x-2">
          <% if (hasPrevPage) { %>
            <a href="?page=<%= currentPage - 1 %>" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Previous</a>
          <% } %>

          <% for (let i = 1; i <= totalPages; i++) { %>
            <a href="?page=<%= i %>"
               class="px-4 py-2 <%= i === currentPage ? 'bg-black text-white' : 'bg-gray-100 text-gray-700' %> rounded hover:bg-gray-300">
              <%= i %>
            </a>
          <% } %>

          <% if (hasNextPage) { %>
            <a href="?page=<%= currentPage + 1 %>" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Next</a>
          <% } %>
        </div>
      <% } %>

    </main>

  </div>

  <!-- Alpine.js & SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.10/dist/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // Add to cart function using POST request
    async function addToCart(productId, variantId) {
      try {
        const response = await fetch('/cart/add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest' // For Express to recognize AJAX request
          },
          body: JSON.stringify({ 
            productId: productId, 
            variantId: variantId,
            quantity: 1
          }),
          credentials: 'same-origin' // Include cookies for authentication
        });

        const result = await response.json();
        
        if (response.ok) {
          // Show success modal
          Swal.fire({
            title: 'Added to Cart!',
            text: 'The item has been successfully added to your cart.',
            icon: 'success',
            timer: 1500,
            showConfirmButton: false
          });
          location.reload();

          // Optionally update cart count in UI
          updateCartCount();
        } else {
          throw new Error(result.message || 'Failed to add item to cart');
        }
      } catch (error) {
        console.error('Add to cart error:', error);
        Swal.fire({
          title: 'Error!',
          text: error.message || 'Something went wrong. Please try again.',
          icon: 'error'
        });
      }
    }
    
    // Function to update cart count in UI (optional)
    function updateCartCount() {
      // This is a simple example - you may need to adjust based on your actual cart implementation
      fetch('/cart/count')
        .then(response => response.json())
        .then(data => {
          if (data.count) {
            // Find cart button and update badge if exists
            const cartButton = document.querySelector('.relative[onclick="window.location.href=\'/cart\'"]');
            if (cartButton) {
              // Remove existing badge if any
              const existingBadge = cartButton.querySelector('.cart-badge');
              if (existingBadge) existingBadge.remove();
              
              // Add new badge
              const badge = document.createElement('span');
              badge.className = 'cart-badge absolute -top-2 -right-2 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center';
              badge.textContent = data.count;
              cartButton.appendChild(badge);
            }
          }
        })
        .catch(error => console.error('Error updating cart count:', error));
    }

    // Delete wishlist item function
    async function confirmDeleteWishlistItem(itemId) {
      const result = await Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to undo this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, remove it!',
        cancelButtonText: 'Cancel'
      });

      if (result.isConfirmed) {
        try {
          const response = await fetch(`/wishlist/remove?itemId=${encodeURIComponent(itemId)}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            Swal.fire({
              title: 'Removed!',
              text: 'Item has been removed from your wishlist.',
              icon: 'success',
              timer: 1500,
              showConfirmButton: false
            }).then(() => {
              window.location.reload();
            });
          } else {
            throw new Error('Failed to remove item');
          }
        } catch (error) {
          console.error('Remove error:', error);
          Swal.fire({
            title: 'Error!',
            text: 'Something went wrong. Please try again.',
            icon: 'error'
          });
        }
      }
    }
  </script>
</body>
</html>