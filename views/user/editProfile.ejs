<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" sizes="32x32" href="/logoTab.png">
  <title>Edit Profile | Casen</title>

  <!-- Tailwind CSS via CDN (fixed URL: no trailing space!) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome (fixed URL) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Alpine.js (fixed URL) -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.10/dist/cdn.min.js"></script>

  <!-- Inter Font -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
    }
  </style>

  <!-- Cropper.js CSS (fixed URL) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-gray-50 text-gray-800">
  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center">
        <a href="/">
          <img src="/logo.png" alt="Logo" class="h-8 object-contain">
        </a>
      </div>

      <nav class="hidden md:flex space-x-5">
        <a href="/" class="text-sm font-medium transition-opacity hover:opacity-80">Home</a>
        <a href="#" class="text-sm font-medium transition-opacity hover:opacity-80">About</a>
        <a href="/products" class="text-sm font-medium transition-opacity hover:opacity-80">Phone Cases</a>
        <a href="#" class="text-sm font-medium transition-opacity hover:opacity-80">Tablet Cases</a>
        <a href="#" class="text-sm font-medium transition-opacity hover:opacity-80">Sale</a>
      </nav>

      <div class="flex items-center space-x-4">
        <button class="p-2 rounded-full hover:bg-gray-100 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" onclick="window.location.href='/profile/wishlist'">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
          </svg>
        </button>

        <button class="p-2 rounded-full hover:bg-gray-100 transition-colors relative"
          onclick="window.location.href='/cart'">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
        </button>

        <% if (locals.user && user.profilePic) { %>
          <div class="relative" x-data="{ open: false }" @click.away="open = false">
            <button @click="open = !open"
              class="rounded-full overflow-hidden w-8 h-8 border border-transparent hover:border-gray-300 transition-colors focus:outline-none">
              <img src="<%= user.profilePic %>" alt="Profile" class="w-full h-full object-cover" />
            </button>
            <div x-show="open" x-transition:enter="transition ease-out duration-150"
              x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
              x-transition:leave="transition ease-in duration-100" x-transition:leave-start="opacity-100 scale-100"
              x-transition:leave-end="opacity-0 scale-95"
              class="absolute right-0 mt-2 w-44 bg-white shadow-lg rounded-lg py-1 z-50">
              <a href="/profile"
                class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">Profile</a>
              <form action="/logout" method="post">
                <button type="submit"
                  class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">Logout</button>
              </form>
            </div>
          </div>
          <% } else if (locals.user) { %>
            <div class="relative" x-data="{ open: false }" @click.away="open = false">
              <button @click="open = !open"
                class="w-8 h-8 flex items-center justify-center text-gray-600 hover:text-gray-900 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
              </button>
              <div x-show="open" x-transition:enter="transition ease-out duration-150"
                x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
                x-transition:leave="transition ease-in duration-100" x-transition:leave-start="opacity-100 scale-100"
                x-transition:leave-end="opacity-0 scale-95"
                class="absolute right-0 mt-2 w-44 bg-white shadow-lg rounded-lg py-1 z-50">
                <a href="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Profile</a>
                <form action="/logout" method="post">
                  <button type="submit"
                    class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Logout</button>
                </form>
              </div>
            </div>
            <% } else { %>
              <a href="/login"
                class="text-sm font-medium text-red-600 hover:text-red-700 transition-colors flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                Sign In
              </a>
              <% } %>

                <button class="md:hidden text-gray-600 hover:text-gray-900">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                  </svg>
                </button>
      </div>
    </div>
  </header>

  <!-- Main Layout -->
  <div class="container mx-auto px-4 py-8 flex flex-col lg:flex-row gap-6">
    <!-- Sidebar -->
    <aside class="lg:w-60 bg-white rounded-xl shadow-sm overflow-hidden">
      <nav class="p-4 space-y-1">
        <a href="/profile"
          class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
          <i class="fas fa-user text-sm"></i>
          <span class="font-medium text-sm">Profile</span>
        </a>
        <a href="/profile/orders"
          class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
          <i class="fas fa-shopping-cart text-sm"></i>
          <span class="font-medium text-sm">Orders</span>
        </a>
        <a href="/wishlist"
          class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
          <i class="far fa-heart text-sm"></i>
          <span class="font-medium text-sm">Wishlist</span>
        </a>
        <a href="/profile/address"
          class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
          <i class="fas fa-home text-sm"></i>
          <span class="font-medium text-sm">Address</span>
        </a>
        <a href="/profile/newPassword"
          class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
          <i class="fas fa-lock text-sm"></i>
          <span class="font-medium text-sm">Password</span>
        </a>
        <a href="/wallet"
          class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
          <i class="fas fa-wallet text-sm"></i>
          <span class="font-medium text-sm">Wallet</span>
        </a>
        <a href="/referral"
          class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
          <i class="fas fa-users text-sm"></i>
          <span class="font-medium text-sm">Referral</span>
        </a>
        <a href="#" onclick="document.getElementById('logout-form').submit();"
          class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors mt-4">
          <i class="fas fa-sign-out-alt text-sm"></i>
          <span class="font-medium text-sm">Logout</span>
        </a>
        <form id="logout-form" action="/logout" method="post" class="hidden"></form>
      </nav>
    </aside>

    <!-- Edit Form -->
    <main class="flex-1 bg-white rounded-xl shadow-sm p-6 md:p-8">
      <div class="flex items-center justify-between mb-8">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Edit Profile</h1>
        <a href="/profile" class="text-sm text-gray-500 hover:text-gray-700 flex items-center">
          <i class="fas fa-arrow-left mr-1"></i> Back
        </a>
      </div>

      <!-- Profile Picture Upload -->
      <div class="flex justify-center mb-8">
        <div class="relative group">
          <label for="profile-pic-input" class="block cursor-pointer">
            <div id="preview-wrapper" class="w-28 h-28 md:w-32 md:h-32">
              <% if (user.profilePic) { %>
                <img src="<%= user.profilePic %>" id="preview-pic" alt="Profile preview"
                  class="w-full h-full rounded-full object-cover border-4 border-white shadow-sm transition-opacity group-hover:opacity-90" />
                <% } else { %>
                  <div id="preview-placeholder"
                    class="w-full h-full rounded-full bg-gray-100 border-4 border-white shadow-sm flex items-center justify-center">
                    <svg class="w-12 h-12 text-gray-400" viewBox="0 0 24 24" fill="currentColor">
                      <path
                        d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                    </svg>
                  </div>
                  <% } %>
            </div>
          </label>

          <label for="profile-pic-input"
            class="absolute bottom-1 right-1 bg-black text-white p-1.5 rounded-full hover:scale-105 transition-transform cursor-pointer z-10">
            <i class="fas fa-camera text-xs"></i>
          </label>

        </div>
      </div>

      <!-- Form -->
      <form id="profile-edit-form" action="/profile/edit?_method=PUT" method="POST" enctype="multipart/form-data"
        class="space-y-6">
        <!-- ⚠️ NO hidden Base64 input -->
        <input type="file" id="profile-pic-input" name="profilePic" accept="image/*" class="hidden" />

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="firstName" class="block text-xs text-gray-500 uppercase tracking-wide mb-1">First Name</label>
            <input type="text" id="firstName" name="firstName" value="<%= user.firstName || '' %>"
              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition"
              required />
          </div>

          <div>
            <label for="lastName" class="block text-xs text-gray-500 uppercase tracking-wide mb-1">Last Name</label>
            <input type="text" id="lastName" name="lastName" value="<%= user.lastName || '' %>"
              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition"
              required />
          </div>

          <div>
            <label for="email" class="block text-xs text-gray-500 uppercase tracking-wide mb-1">Email</label>
            <input type="email" id="email" name="email" value="<%= user.email || '' %>"
              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition"
              required />
          </div>

          <div>
            <label for="phoneNumber" class="block text-xs text-gray-500 uppercase tracking-wide mb-1">Mobile
              Number</label>
            <input type="tel" id="phoneNumber" name="phoneNumber" value="<%= user.phoneNumber || '' %>"
              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition"
              required />
          </div>
        </div>

        <div class="flex flex-col sm:flex-row sm:justify-end gap-3 pt-4">
          <a href="/profile"
            class="px-5 py-2.5 text-center text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
            Cancel
          </a>
          <button type="submit"
            class="px-5 py-2.5 text-center text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 focus:ring-4 focus:ring-red-300 transition-colors">
            Save Changes
          </button>
        </div>
      </form>
    </main>
  </div>

  <!-- Mobile Bottom Nav -->
  <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-3">
    <div class="flex justify-around">
      <a href="/" class="flex flex-col items-center text-xs text-gray-600 hover:text-red-600 transition-colors">
        <i class="fas fa-home text-lg mb-1"></i>
        <span>Home</span>
      </a>
      <a href="/cart" class="flex flex-col items-center text-xs text-gray-600 hover:text-red-600 transition-colors">
        <i class="fas fa-shopping-cart text-lg mb-1"></i>
        <span>Cart</span>
      </a>
      <a href="/wishlist" class="flex flex-col items-center text-xs text-gray-600 hover:text-red-600 transition-colors">
        <i class="far fa-heart text-lg mb-1"></i>
        <span>Wishlist</span>
      </a>
      <a href="/profile" class="flex flex-col items-center text-xs text-gray-600 hover:text-red-600 transition-colors">
        <% if (user.profilePic) { %>
          <img src="<%= user.profilePic %>" alt="User" class="w-6 h-6 rounded-full mb-1 object-cover" />
          <% } else { %>
            <svg class="w-6 h-6 rounded-full mb-1 text-gray-500 bg-gray-100" viewBox="0 0 24 24" fill="currentColor">
              <path
                d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
            </svg>
            <% } %>
              <span>Profile</span>
      </a>
    </div>
  </div>

  <!-- Cropping Modal -->
  <div id="cropper-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-4 max-w-md w-full">
      <h3 class="text-center text-sm font-medium mb-3">Adjust your photo</h3>
      <div class="overflow-hidden rounded-lg border">
        <img id="cropper-image" src="" class="max-w-full" />
      </div>
      <div class="mt-4 flex justify-between items-center">
        <div class="flex space-x-2">
          <button id="zoom-out" type="button" class="px-3 py-1 text-xs bg-gray-200 rounded hover:bg-gray-300">−</button>
          <button id="zoom-in" type="button" class="px-3 py-1 text-xs bg-gray-200 rounded hover:bg-gray-300">+</button>
        </div>
        <div class="flex space-x-2">
          <button id="cancel-crop" type="button"
            class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
          <button id="confirm-crop" type="button"
            class="px-4 py-2 text-sm bg-red-600 text-white rounded hover:bg-red-700">Use Photo</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Cropper.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

  <script>
    let cropper;

    document.getElementById('profile-pic-input').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file || !file.type.startsWith('image/')) return;

      const reader = new FileReader();
      reader.onload = function (event) {
        const img = document.getElementById('cropper-image');
        img.src = event.target.result;
        document.getElementById('cropper-modal').classList.remove('hidden');

        if (cropper) cropper.destroy();
        cropper = new Cropper(img, {
          aspectRatio: 1,
          viewMode: 1,
          dragMode: 'move',
          autoCropArea: 0.9,
          responsive: true,
          center: true,
          highlight: false,
          cropBoxMovable: true,
          cropBoxResizable: false,
          guides: false,
          background: true,
        });
      };
      reader.readAsDataURL(file);
    });

    document.getElementById('confirm-crop').addEventListener('click', function () {
      if (!cropper) return;

      const circleCanvas = document.createElement('canvas');
      const ctx = circleCanvas.getContext('2d');
      const [croppedCanvas] = [cropper.getCroppedCanvas({ width: 300, height: 300 })];
      circleCanvas.width = 300;
      circleCanvas.height = 300;

      ctx.beginPath();
      ctx.arc(150, 150, 150, 0, Math.PI * 2, true);
      ctx.closePath();
      ctx.clip();
      ctx.drawImage(croppedCanvas, 0, 0, 300, 300);

      circleCanvas.toBlob(blob => {
        if (!blob) return;

        const file = new File([blob], "profile.png", { type: "image/png" });

        let fileInput = document.querySelector('input[name="profilePic"]');
        if (!fileInput) {
          fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.name = 'profilePic';
          fileInput.className = 'hidden';
          document.querySelector('form').appendChild(fileInput);
        }

        const dt = new DataTransfer();
        dt.items.add(file);
        fileInput.files = dt.files;

        const previewUrl = URL.createObjectURL(file);
        const preview = document.createElement('img');
        preview.src = previewUrl;
        preview.className = 'w-full h-full rounded-full object-cover border-4 border-white shadow-sm';
        const wrapper = document.getElementById('preview-wrapper');
        wrapper.innerHTML = '';
        wrapper.appendChild(preview);

        document.getElementById('cropper-modal').classList.add('hidden');
        cropper.destroy();
        cropper = null;
      }, 'image/png');
    });

    document.getElementById('cancel-crop').addEventListener('click', function () {
      document.getElementById('cropper-modal').classList.add('hidden');
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      document.getElementById('profile-pic-input').value = '';
    });

    document.getElementById('zoom-in').addEventListener('click', () => { if (cropper) cropper.zoom(0.1); });
    document.getElementById('zoom-out').addEventListener('click', () => { if (cropper) cropper.zoom(-0.1); });

    // SweetAlert2 form submission handler
    document.getElementById('profile-edit-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      const formData = new FormData(this);

      // Show loading alert
      Swal.fire({
        title: 'Saving...',
        text: 'Please wait while we update your profile.',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      try {
        const response = await fetch(this.action, {
          method: 'POST',
          body: formData,
          headers: {
            'Accept': 'application/json' // Optional: help backend detect JSON response if needed
          }
        });

        const result = await response.json(); // Expect JSON from backend

        if (result.success) {
          if (result.redirect) {
            // Handle redirect (e.g., email change flow)
            window.location.href = result.redirect;
          } else {
            // Normal success (profile updated without email change)
            Swal.fire({
              icon: 'success',
              title: 'Success!',
              text: 'Your profile has been updated.',
              confirmButtonText: 'OK'
            }).then(() => {
              window.location.href = '/profile';
            });
          }
        } else {
          // Show error
          Swal.fire({
            icon: 'error',
            title: 'Update Failed',
            text: result.message || 'Something went wrong. Please try again.',
            confirmButtonText: 'OK'
          });
        }
      } catch (error) {
        console.error('Submission error:', error);
        Swal.fire({
          icon: 'error',
          title: 'Network Error',
          text: 'Failed to connect to the server. Please check your connection.',
          confirmButtonText: 'OK'
        });
      }
    });
  </script>
</body>

</html>