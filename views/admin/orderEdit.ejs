<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Caseify Admin - Order Details</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/logoTab.png" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="/customersPage.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body class="bg-gray-50">
    <div class="dashboard-container">
        <!-- Sidebar -->
        <%- include('partial/aside', {
            selected: 'orders'
        }) %>
        
        <!-- Main Content -->
        <main class="main-dashboard">
            <div class="dashboard-header">
                <div class="flex items-center gap-3">
                    <a href="/admin/order" class="p-2.5 rounded-lg border border-gray-200 hover:bg-gray-50 transition">
                        <i class="fas fa-arrow-left text-gray-600"></i>
                    </a>
                    <h1 class="page-title">Order Details</h1>
                </div>
            </div>
            
            <div class="content-area p-4 sm:p-6 max-w-7xl mx-auto w-full">
                <% if (!order) { %>
                    <div class="flex items-center justify-center h-64 text-red-600 text-lg">
                        Order data not found.
                    </div>
                <% } else {
                    const statusColors = {
                        'pending': 'bg-amber-100 text-amber-800',
                        'processing': 'bg-indigo-100 text-indigo-800',
                        'shipped': 'bg-emerald-100 text-emerald-800',
                        'delivered': 'bg-green-100 text-green-800',
                        'cancelled': 'bg-rose-100 text-rose-800',
                        'confirmed': 'bg-sky-100 text-sky-800',
                        'returned': 'bg-purple-100 text-purple-800',
                        'requestingReturn': 'bg-orange-100 text-orange-800'
                    };
                    
                    const itemStatusColors = {
                        'pending': 'text-amber-700 bg-amber-100',
                        'confirmed': 'text-sky-700 bg-sky-100',
                        'processing': 'text-indigo-700 bg-indigo-100',
                        'shipped': 'text-emerald-700 bg-emerald-100',
                        'delivered': 'text-green-700 bg-green-100',
                        'cancelled': 'text-rose-700 bg-rose-100',
                        'returned': 'text-purple-700 bg-purple-100',
                        'requestingReturn': 'text-orange-700 bg-orange-100'
                    };
                    
                    const statusDotColors = {
                        'pending': 'bg-amber-500',
                        'confirmed': 'bg-sky-500',
                        'processing': 'bg-indigo-500',
                        'shipped': 'bg-emerald-500',
                        'delivered': 'bg-green-500',
                        'cancelled': 'bg-rose-500',
                        'requestingReturn': 'bg-orange-500',
                        'returned': 'bg-purple-500'
                    };
                    
                    // Define the order status flow
                    const statusOrder = ['pending', 'confirmed', 'processing', 'shipped', 'delivered'];
                    const currentStatus = order.orderStatus;
                    
                    // Determine which statuses are allowed for the order
                    let allowedStatuses = [currentStatus];
                    
                    // Only allow cancellation if order hasn't been delivered or is already cancelled
                    if (!['delivered', 'returned', 'cancelled'].includes(currentStatus)) {
                        // Add next status in the workflow
                        const idx = statusOrder.indexOf(currentStatus);
                        if (idx !== -1 && idx + 1 < statusOrder.length) {
                            allowedStatuses.push(statusOrder[idx + 1]);
                        }
                        
                        // Add cancellation option only if not delivered or already cancelled
                        allowedStatuses.push('cancelled');
                    }
                    
                    const isStatusAllowed = (status) => allowedStatuses.includes(status);
                    const statuses = ['pending', 'confirmed', 'processing', 'shipped', 'delivered', 'cancelled', 'requestingReturn', 'returned'];
                    
                    // Admin cannot request returns - only approve/deny them
                    const allowedItemStatuses = {
                        'pending': ['confirmed', 'cancelled'],
                        'confirmed': ['processing', 'cancelled'],
                        'processing': ['shipped', 'cancelled'],
                        'shipped': ['delivered', 'cancelled'],  // Keep item-level cancellation for shipped items
                        'delivered': [],
                        'cancelled': [],
                        'returned': [],
                        'requestingReturn': ['returned', 'delivered']
                    };
                %>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Left Column -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Order Summary -->
                        <div class="bg-white rounded-xl shadow-sm p-5 sm:p-6 border border-gray-100">
                            <div class="flex flex-wrap items-start justify-between gap-3">
                                <div>
                                    <h2 class="text-xl font-bold text-gray-900">
                                        Order #<%- order.orderId.toString().slice(-6) %>
                                    </h2>
                                    <p class="text-sm text-gray-500 mt-1">
                                        Placed on <%- new Date(order.createdAt).toLocaleDateString() %>
                                    </p>
                                </div>
                                <span class="px-3 py-1.5 <%= statusColors[order.orderStatus] || 'bg-gray-100 text-gray-800' %> text-sm font-medium rounded-full">
                                    <%- order.orderStatus.charAt(0).toUpperCase() + order.orderStatus.slice(1) %>
                                </span>
                            </div>
                            <div class="mt-4 flex items-center">
                                <div class="flex items-center">
                                    <div class="w-5 h-5
                                        <% if (order.paymentStatus === 'paid') { %> bg-green-500 <% } else { %> bg-yellow-500 <% } %>
                                        rounded-full flex items-center justify-center mr-2">
                                        <i class="fas fa-check text-white text-xs"></i>
                                    </div>
                                    <span class="text-sm font-medium text-gray-900">
                                        <%- order.paymentStatus.charAt(0).toUpperCase() + order.paymentStatus.slice(1) %>
                                    </span>
                                </div>
                            </div>
                            
                            <% if (order.orderStatus === 'requestingReturn') { %>
                                <div class="mt-3 p-3 bg-orange-50 border border-orange-200 rounded-lg">
                                    <p class="text-sm font-medium text-orange-800 mb-1">Order Return Reason:</p>
                                    <p class="text-sm text-orange-700">
                                        <%- order.returnReason || 'No reason provided' %>
                                    </p>
                                    <div class="mt-2 flex flex-wrap gap-2">
                                        <form action="/admin/order/<%- order._id %>/return-status?userId=<%= order.userId %>" method="POST" class="inline-block">
                                            <input type="hidden" name="status" value="approved">
                                            <button type="submit" class="px-3 py-1.5 text-xs font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg transition">
                                                Approve Full Return
                                            </button>
                                        </form>
                                        <form action="/admin/order/<%- order._id %>/return-status?userId=<%= order.userId %>" method="POST" class="inline-block">
                                            <input type="hidden" name="status" value="denied">
                                            <button type="submit" class="px-3 py-1.5 text-xs font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg transition">
                                                Deny Return
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            <% } %>
                        </div>
                        
                        <!-- Order Items -->
                        <div class="bg-white rounded-xl shadow-sm p-5 sm:p-6 border border-gray-100">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Order Items</h3>
                            <div class="space-y-4">
                                <% (order.items || []).forEach(item => {
                                    // Preserve item-specific statuses including 'requestingReturn'
                                    let displayStatus = item.orderStatus;
                                    if (order.orderStatus === 'delivered' &&
                                        !['cancelled', 'returned', 'requestingReturn'].includes(item.orderStatus)) {
                                        displayStatus = 'delivered';
                                    }
                                    
                                    // Modified logic to NOT show change status button for items in 'requestingReturn' status
                                    // Only allow status changes for items not in final states
                                    const canChangeStatus =
                                        !['cancelled', 'returned', 'requestingReturn'].includes(displayStatus) &&
                                        displayStatus !== 'delivered';
                                %>
                                    <div class="flex flex-col sm:flex-row sm:items-start justify-between pb-4 border-b border-gray-100 last:border-0 last:pb-0">
                                        <div class="flex items-start space-x-4 w-full">
                                            <img
                                                src="<%- (item.images?.[0] || '').trim() || 'https://via.placeholder.com/60' %>"
                                                alt="<%- item.productName %>"
                                                class="w-14 h-14 rounded-lg object-cover shrink-0"
                                            />
                                            <div class="flex-1 min-w-0">
                                                <p class="font-medium text-gray-900"><%- item.productName %></p>
                                                <p class="text-sm text-gray-500">Qty: <%- item.quantity %></p>
                                                <div class="flex items-center mt-1">
                                                    <span class="inline-block px-2 py-0.5 text-xs font-medium rounded-full <%= itemStatusColors[displayStatus] || 'bg-gray-100 text-gray-800' %>">
                                                        <%- displayStatus.charAt(0).toUpperCase() + displayStatus.slice(1) %>
                                                    </span>
                                                    <% if (canChangeStatus) { %>
                                                        <button class="ml-2 text-xs text-blue-600 hover:text-blue-800" onclick="openItemStatusModal('<%- item.orderItemId %>', '<%- displayStatus %>', '<%- item.productName %>')">
                                                            Change Status
                                                        </button>
                                                    <% } %>
                                                </div>
                                                
                                                <!-- Return request details and actions for items -->
                                                <% if (displayStatus === 'requestingReturn') { %>
                                                    <div class="mt-2 p-3 bg-orange-50 border border-orange-200 rounded-lg">
                                                        <p class="text-sm font-medium text-orange-800 mb-1">Return Reason:</p>
                                                        <p class="text-sm text-orange-700">
                                                            <%- item.returnReason || order.returnReason || 'No reason provided' %>
                                                        </p>
                                                        <div class="mt-2 flex flex-wrap gap-2">
                                                            <form action="/admin/order/<%- order._id %>/item/<%- item.orderItemId %>/return-status?userId=<%= order.userId %>" method="POST" class="inline-block">
                                                                <input type="hidden" name="status" value="approved">
                                                                <button type="submit" class="px-3 py-1.5 text-xs font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg transition">
                                                                    Approve Return
                                                                </button>
                                                            </form>
                                                            <form action="/admin/order/<%- order._id %>/item/<%- item.orderItemId %>/return-status?userId=<%= order.userId %>" method="POST" class="inline-block">
                                                                <input type="hidden" name="status" value="denied">
                                                                <button type="submit" class="px-3 py-1.5 text-xs font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg transition">
                                                                    Deny Return
                                                                </button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                <% } %>
                                            </div>
                                        </div>
                                        <p class="font-medium text-gray-900 mt-2 sm:mt-0 shrink-0">₹<%- (item.price * item.quantity).toFixed(2) %></p>
                                    </div>
                                <% }) %>
                            </div>
                            
                            <!-- Totals -->
                            <div class="mt-6 pt-4 border-t border-gray-100">
                                <div class="space-y-1.5 text-sm">
                                    <div class="flex justify-between"><span class="text-gray-600">Subtotal</span> <span>₹<%- (Number(order.subTotal) || 0).toFixed(2) %></span></div>
                                    <div class="flex justify-between"><span class="text-gray-600">Discount</span> <span>-₹<%- (Number(order.discountAmount) || 0).toFixed(2) %></span></div>
                                    <div class="flex justify-between"><span class="text-gray-600">Shipping</span> <span>₹<%- (Number(order.shipping) || 0).toFixed(2) %></span></div>
                                    <div class="flex justify-between"><span class="text-gray-600">Tax</span> <span>₹<%- (Number(order.taxAmount) || 0).toFixed(2) %></span></div>
                                </div>
                                <div class="flex justify-between mt-3 pt-3 border-t border-gray-200">
                                    <span class="font-semibold text-gray-900">Total</span>
                                    <span class="text-lg font-bold text-gray-900">₹<%- (Number(order.totalAmount) || 0).toFixed(2) %></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Order Actions -->
                        <% if (!['cancelled', 'returned', 'delivered'].includes(order.orderStatus)) { %>
                            <div class="bg-white rounded-xl shadow-sm p-5 sm:p-6 border border-gray-100">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Order Actions</h3>
                                <button id="openStatusModal" class="w-full flex items-center justify-center space-x-2 px-4 py-2.5 bg-black text-white rounded-lg hover:bg-gray-900 transition font-medium shadow-sm">
                                    <i class="fas fa-sync-alt"></i>
                                    <span>Change Order Status</span>
                                </button>
                            </div>
                        <% } %>
                    </div>
                    
                    <!-- Right Column -->
                    <div class="space-y-6">
                        <!-- Customer -->
                        <div class="bg-white rounded-xl shadow-sm p-5 sm:p-6 border border-gray-100">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Customer</h3>
                            <div class="space-y-2 text-sm">
                                <p class="font-medium"><%- (order.userDetails?.firstName || '') + ' ' + (order.userDetails?.lastName || '') || 'N/A' %></p>
                                <p class="text-gray-600"><%- order.userDetails?.email || 'N/A' %></p>
                                <p class="text-gray-600"><%- order.userDetails?.phoneNumber || 'N/A' %></p>
                            </div>
                        </div>
                        
                        <!-- Shipping Address -->
                        <div class="bg-white rounded-xl shadow-sm p-5 sm:p-6 border border-gray-100">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Shipping Address</h3>
                            <address class="not-italic text-sm text-gray-600 space-y-1">
                                <p><%- order.address?.fullName || '—' %></p>
                                <p><%- order.address?.streetAddress || '—' %></p>
                                <p>
                                    <%- order.address?.city || '' %>,
                                    <%- order.address?.state || '' %>
                                    <%- order.address?.postalCode || '' %>
                                </p>
                                <p>
                                    <%- order.address?.country || '—' %>,
                                    <%- order.address?.phoneNumber || 'N/A' %>
                                </p>
                            </address>
                        </div>
                        
                        <!-- Billing -->
                        <div class="bg-white rounded-xl shadow-sm p-5 sm:p-6 border border-gray-100">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Billing</h3>
                            <p class="text-sm text-gray-600 mb-2">
                                <% if (order.billingSameAsShipping) { %>
                                    Same as shipping address
                                <% } else { %>
                                    Different billing address
                                <% } %>
                            </p>
                            <% if (order.paymentMethod) { %>
                                <div class="flex items-center space-x-2 text-sm text-gray-600">
                                    <i class="fab fa-cc-<%- order.paymentMethod === 'visa' ? 'visa' : order.paymentMethod %> text-lg text-blue-600"></i>
                                    <span>•••• <%- order.cardLast4 || '1234' %></span>
                                </div>
                            <% } %>
                        </div>
                        
                        <!-- Return Request Info -->
                        <% if (['requestingReturn', 'returned'].includes(order.orderStatus)) { %>
                            <div class="bg-white rounded-xl shadow-sm p-5 sm:p-6 border border-gray-100">
                                <h3 class="text-lg font-semibold text-gray-900 mb-3">
                                    <% if (order.orderStatus === 'returned') { %>
                                        Return Completed
                                    <% } else { %>
                                        Return Requested
                                    <% } %>
                                </h3>
                                <div class="space-y-2 text-sm">
                                    <% if (order.returnReason) { %>
                                        <p class="text-gray-700">
                                            <span class="font-medium">Reason:</span> <%- order.returnReason %>
                                        </p>
                                    <% } else { %>
                                        <p class="text-gray-500 italic">No reason provided.</p>
                                    <% } %>
                                    <% if (order.returnRequestedAt) { %>
                                        <p class="text-gray-600">
                                            <span class="font-medium">Requested on:</span>
                                            <%- new Date(order.returnRequestedAt).toLocaleString() %>
                                        </p>
                                    <% } %>
                                    <% if (order.orderStatus === 'returned' && order.returnApprovedAt) { %>
                                        <p class="text-gray-600">
                                            <span class="font-medium">Approved on:</span>
                                            <%- new Date(order.returnApprovedAt).toLocaleString() %>
                                        </p>
                                    <% } %>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </div>
                
                <!-- Status Update Modal -->
                <div id="statusModal" class="fixed inset-0 z-50 hidden">
                    <div class="absolute inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm"></div>
                    <div class="relative min-h-screen flex items-center justify-center p-4">
                        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden relative z-10">
                            <div class="bg-black p-5 text-white">
                                <div class="flex justify-between items-center">
                                    <h3 class="text-xl font-bold">Update Order Status</h3>
                                    <button id="closeModal" class="text-gray-300 hover:text-white p-1 rounded-full">
                                        <i class="fas fa-times text-lg"></i>
                                    </button>
                                </div>
                                <p class="text-gray-200 text-sm mt-1">
                                    Current: <span class="font-medium">
                                        <%- order.orderStatus.charAt(0).toUpperCase() + order.orderStatus.slice(1) %>
                                    </span>
                                </p>
                            </div>
                            <form id="statusUpdateForm" action="/admin/order/<%- order._id %>/update-status?userId=<%= order.userId %>" method="POST" class="p-5">
                                <div class="space-y-2.5 mb-6">
                                    <% statuses.forEach(status => {
                                        const isSelected = order.orderStatus === status;
                                        const dotColor = statusDotColors[status];
                                        const colorName = dotColor.split('-')[1];
                                        const isDisabled = !isStatusAllowed(status);
                                    %>
                                        <label class="flex items-center p-3 rounded-xl border <%= isSelected ? `border-${colorName}-200 bg-${colorName}-50` : 'border-gray-300 hover:bg-gray-50' %> cursor-pointer transition group js-status-option <%= isDisabled ? 'opacity-50 pointer-events-none' : '' %>" data-status="<%- status %>">
                                            <div class="flex items-center">
                                                <span class="<%= dotColor %> w-3 h-3 rounded-full mr-3"></span>
                                                <span class="font-medium text-gray-800">
                                                    <%- status.charAt(0).toUpperCase() + status.slice(1) %>
                                                </span>
                                            </div>
                                            <input
                                                type="radio"
                                                name="status"
                                                value="<%- status %>"
                                                <%= isSelected ? 'checked' : '' %>
                                                <%= isDisabled ? 'disabled' : '' %>
                                                class="sr-only js-status-radio"
                                            />
                                            <i class="fas fa-check-circle text-<%= colorName %> ml-auto text-lg js-checkmark <%= isSelected ? '' : 'hidden' %>"></i>
                                        </label>
                                    <% }) %>
                                </div>
                                <div class="flex gap-3">
                                    <button type="button" id="cancelModal" class="flex-1 px-4 py-2.5 border border-gray-300 text-gray-800 rounded-lg hover:bg-gray-100 font-medium transition">
                                        Cancel
                                    </button>
                                    <button type="submit" class="flex-1 px-4 py-2.5 bg-black text-white rounded-lg hover:bg-gray-900 font-medium shadow-md transition">
                                        Apply Change
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Item Status Update Modal -->
                <div id="itemStatusModal" class="fixed inset-0 z-50 hidden">
                    <div class="absolute inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm"></div>
                    <div class="relative min-h-screen flex items-center justify-center p-4">
                        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden relative z-10">
                            <div class="bg-black p-5 text-white">
                                <div class="flex justify-between items-center">
                                    <h3 class="text-xl font-bold">Update Item Status</h3>
                                    <button id="closeItemModal" class="text-gray-300 hover:text-white p-1 rounded-full">
                                        <i class="fas fa-times text-lg"></i>
                                    </button>
                                </div>
                                <p class="text-gray-200 text-sm mt-1">
                                    Item: <span class="font-medium" id="itemNameDisplay"></span>
                                </p>
                                <p class="text-gray-200 text-sm mt-1">
                                    Current: <span class="font-medium" id="currentItemStatus"></span>
                                </p>
                            </div>
                            <form id="itemStatusUpdateForm" method="POST" class="p-5">
                                <input type="hidden" id="orderItemIdInput" name="orderItemId">
                                <div class="space-y-2.5 mb-6">
                                    <% Object.keys(allowedItemStatuses).forEach(status => {
                                        const dotColor = statusDotColors[status];
                                        const colorName = dotColor ? dotColor.split('-')[1] : 'gray';
                                    %>
                                        <label class="flex items-center p-3 rounded-xl border border-gray-300 hover:bg-gray-50 cursor-pointer transition group js-item-status-option hidden" data-status="<%- status %>">
                                            <div class="flex items-center">
                                                <span class="<%= dotColor || 'bg-gray-500' %> w-3 h-3 rounded-full mr-3"></span>
                                                <span class="font-medium text-gray-800">
                                                    <%- status.charAt(0).toUpperCase() + status.slice(1) %>
                                                </span>
                                            </div>
                                            <input
                                                type="radio"
                                                name="status"
                                                value="<%- status %>"
                                                class="sr-only js-item-status-radio"
                                            />
                                            <i class="fas fa-check-circle text-<%= colorName %> ml-auto text-lg js-checkmark hidden"></i>
                                        </label>
                                    <% }) %>
                                </div>
                                <div class="flex gap-3">
                                    <button type="button" id="cancelItemModal" class="flex-1 px-4 py-2.5 border border-gray-300 text-gray-800 rounded-lg hover:bg-gray-100 font-medium transition">
                                        Cancel
                                    </button>
                                    <button type="submit" class="flex-1 px-4 py-2.5 bg-black text-white rounded-lg hover:bg-gray-900 font-medium shadow-md transition">
                                        Apply Change
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <% } %>
            </div>
        </main>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('statusModal');
            const itemModal = document.getElementById('itemStatusModal');
            const openBtn = document.getElementById('openStatusModal');
            const closeBtn = document.getElementById('closeModal');
            const closeItemBtn = document.getElementById('closeItemModal');
            const cancelBtn = document.getElementById('cancelModal');
            const cancelItemBtn = document.getElementById('cancelItemModal');
            const statusForm = document.getElementById('statusUpdateForm');
            const itemStatusForm = document.getElementById('itemStatusUpdateForm');
            const originalStatus = "<%- order?.orderStatus || '' %>";
            const orderId = "<%- order?._id || '' %>";
            const userId = "<%= order?.userId || '' %>";
            
            function resetModalToOriginalStatus() {
                document.querySelectorAll('.js-status-radio').forEach(radio => {
                    const isSelected = radio.value === originalStatus;
                    radio.checked = isSelected;
                    const checkmark = radio.closest('.js-status-option')?.querySelector('.js-checkmark');
                    if (checkmark) checkmark.classList.toggle('hidden', !isSelected);
                });
            }
            
            function openModal() {
                resetModalToOriginalStatus();
                modal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            }
            
            function closeModal() {
                modal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }
            
            function openItemStatusModal(orderItemId, currentStatus, itemName) {
                // Reset form
                document.querySelectorAll('.js-item-status-radio').forEach(r => r.checked = false);
                document.querySelectorAll('.js-checkmark').forEach(c => c.classList.add('hidden'));
                document.querySelectorAll('.js-item-status-option').forEach(el => el.classList.add('hidden'));
                
                // Set form action
                itemStatusForm.action = `/admin/order/${orderId}/item/${orderItemId}/update-status?userId=${userId}`;
                
                // Set hidden input
                document.getElementById('orderItemIdInput').value = orderItemId;
                
                // Set display values
                document.getElementById('itemNameDisplay').textContent = itemName;
                document.getElementById('currentItemStatus').textContent = currentStatus.charAt(0).toUpperCase() + currentStatus.slice(1);
                
                // Show allowed status options based on current status
                const allowedStatuses = {
                    'pending': ['confirmed', 'cancelled'],
                    'confirmed': ['processing', 'cancelled'],
                    'processing': ['shipped', 'cancelled'],
                    'shipped': ['delivered', 'cancelled'],
                    'delivered': [],
                    'cancelled': [],
                    'returned': [],
                    'requestingReturn': ['returned', 'delivered']
                };
                
                const statusesToShow = allowedStatuses[currentStatus] || [];
                statusesToShow.forEach(status => {
                    const option = document.querySelector(`.js-item-status-option[data-status="${status}"]`);
                    if (option) option.classList.remove('hidden');
                });
                
                // Show modal
                itemModal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            }
            
            function closeItemModal() {
                itemModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }
            
            if (openBtn) {
                openBtn.addEventListener('click', openModal);
            }
            
            if (closeBtn) {
                closeBtn.addEventListener('click', closeModal);
            }
            
            if (closeItemBtn) {
                closeItemBtn.addEventListener('click', closeItemModal);
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', closeModal);
            }
            
            if (cancelItemBtn) {
                cancelItemBtn.addEventListener('click', closeItemModal);
            }
            
            modal?.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            
            itemModal?.addEventListener('click', (e) => {
                if (e.target === itemModal) closeItemModal();
            });
            
            document.querySelectorAll('.js-status-radio').forEach(radio => {
                radio.addEventListener('change', function () {
                    document.querySelectorAll('.js-checkmark').forEach(icon => icon.classList.add('hidden'));
                    const checkmark = this.closest('.js-status-option')?.querySelector('.js-checkmark');
                    if (checkmark) checkmark.classList.remove('hidden');
                });
            });
            
            document.querySelectorAll('.js-item-status-radio').forEach(radio => {
                radio.addEventListener('change', function () {
                    document.querySelectorAll('.js-item-status-option .js-checkmark').forEach(icon => icon.classList.add('hidden'));
                    const checkmark = this.closest('.js-item-status-option')?.querySelector('.js-checkmark');
                    if (checkmark) checkmark.classList.remove('hidden');
                });
            });
            
            // Handle status form submission with SweetAlert2
            if (statusForm) {
                statusForm.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    const selectedRadio = document.querySelector('input[name="status"]:checked');
                    if (!selectedRadio || selectedRadio.value === originalStatus) {
                        Swal.fire({
                            icon: 'info',
                            title: 'No Change',
                            text: 'Please select a different order status.',
                            confirmButtonColor: '#6b7280',
                            confirmButtonText: 'OK'
                        });
                        return;
                    }
                    
                    Swal.fire({
                        title: 'Are you sure?',
                        text: `Do you want to change the order status to "${selectedRadio.value.charAt(0).toUpperCase() + selectedRadio.value.slice(1)}"?`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3b82f6',
                        cancelButtonColor: '#6b7280',
                        confirmButtonText: 'Yes, update it!',
                        cancelButtonText: 'Cancel'
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            const url = statusForm.action;
                            const formData = new URLSearchParams();
                            formData.append('status', selectedRadio.value);
                            
                            try {
                                const response = await fetch(url, {
                                    method: 'POST',
                                    body: formData,
                                    headers: {
                                        'Content-Type': 'application/x-www-form-urlencoded',
                                        'Accept': 'application/json'
                                    }
                                });
                                
                                const result = await response.json();
                                if (response.ok && result.success) {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Success!',
                                        text: result.message || 'Order status updated successfully.',
                                        confirmButtonColor: '#10b981',
                                        confirmButtonText: 'OK'
                                    }).then(() => {
                                        window.location.reload();
                                    });
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Update Failed',
                                        text: result.message || 'Invalid status transition.',
                                        confirmButtonColor: '#ef4444',
                                        confirmButtonText: 'OK'
                                    });
                                }
                            } catch (error) {
                                console.error('Fetch error:', error);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Network Error',
                                    text: 'Something went wrong. Please try again.',
                                    confirmButtonColor: '#ef4444',
                                    confirmButtonText: 'OK'
                                });
                            }
                        }
                    });
                });
            }
            
            // Handle item status form submission
            if (itemStatusForm) {
                itemStatusForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const selectedRadio = document.querySelector('input[name="status"]:checked');
                    if (!selectedRadio) {
                        Swal.fire({
                            icon: 'info',
                            title: 'No Selection',
                            text: 'Please select a status for this item.',
                            confirmButtonColor: '#6b7280',
                            confirmButtonText: 'OK'
                        });
                        return;
                    }
                    
                    const currentStatusText = document.getElementById('currentItemStatus').textContent;
                    const currentStatus = currentStatusText.toLowerCase().replace(/\s+/g, '');
                    if (selectedRadio.value === currentStatus) {
                        Swal.fire({
                            icon: 'info',
                            title: 'No Change',
                            text: 'Please select a different status.',
                            confirmButtonColor: '#6b7280',
                            confirmButtonText: 'OK'
                        });
                        return;
                    }
                    
                    Swal.fire({
                        title: 'Are you sure?',
                        text: `Do you want to change this item's status to "${selectedRadio.value.charAt(0).toUpperCase() + selectedRadio.value.slice(1)}"?`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3b82f6',
                        cancelButtonColor: '#6b7280',
                        confirmButtonText: 'Yes, update it!',
                        cancelButtonText: 'Cancel'
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            const url = itemStatusForm.action;
                            const formData = new URLSearchParams();
                            formData.append('status', selectedRadio.value);
                            
                            try {
                                const response = await fetch(url, {
                                    method: 'POST',
                                    body: formData,
                                    headers: {
                                        'Content-Type': 'application/x-www-form-urlencoded',
                                        'Accept': 'application/json'
                                    }
                                });
                                
                                const result = await response.json();
                                if (response.ok && result.success) {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Success!',
                                        text: result.message || 'Item status updated successfully.',
                                        confirmButtonColor: '#10b981',
                                        confirmButtonText: 'OK'
                                    }).then(() => {
                                        window.location.reload();
                                    });
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Update Failed',
                                        text: result.message || 'Invalid status transition.',
                                        confirmButtonColor: '#ef4444',
                                        confirmButtonText: 'OK'
                                    });
                                }
                            } catch (error) {
                                console.error('Fetch error:', error);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Network Error',
                                    text: 'Something went wrong. Please try again.',
                                    confirmButtonColor: '#ef4444',
                                    confirmButtonText: 'OK'
                                });
                            }
                        }
                    });
                });
            }
            
            // Add SweetAlert confirmation for return approval/denial forms
            document.querySelectorAll('form[action*="/return-status"]').forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const isApprove = this.querySelector('input[name="status"]').value === 'approved';
                    const actionText = isApprove ? 'approve' : 'deny';
                    const actionColor = isApprove ? '#22c55e' : '#ef4444';
                    const actionTitle = isApprove ? 'Approve Return' : 'Deny Return';
                    
                    Swal.fire({
                        title: `Are you sure you want to ${actionText} this return?`,
                        text: "This action cannot be undone.",
                        icon: isApprove ? 'success' : 'warning',
                        showCancelButton: true,
                        confirmButtonColor: actionColor,
                        cancelButtonColor: '#6b7280',
                        confirmButtonText: `Yes, ${actionText} it!`,
                        cancelButtonText: 'Cancel'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Show loading state
                            Swal.fire({
                                title: 'Processing...',
                                allowOutsideClick: false,
                                didOpen: () => {
                                    Swal.showLoading();
                                }
                            });
                            
                            // Submit the form
                            this.submit();
                        }
                    });
                });
            });
            
            // Check for success/error messages in URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const successMessage = urlParams.get('success');
            const errorMessage = urlParams.get('error');
            
            if (successMessage) {
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: decodeURIComponent(successMessage),
                    confirmButtonColor: '#10b981',
                    confirmButtonText: 'OK'
                }).then(() => {
                    // Remove the success parameter from URL
                    const newUrl = window.location.pathname + window.location.hash;
                    window.history.replaceState({}, document.title, newUrl);
                });
            } else if (errorMessage) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: decodeURIComponent(errorMessage),
                    confirmButtonColor: '#ef4444',
                    confirmButtonText: 'OK'
                }).then(() => {
                    // Remove the error parameter from URL
                    const newUrl = window.location.pathname + window.location.hash;
                    window.history.replaceState({}, document.title, newUrl);
                });
            }
            
            // Expose function to global scope for onclick handler
            window.openItemStatusModal = openItemStatusModal;
        });
    </script>
</body>
</html>